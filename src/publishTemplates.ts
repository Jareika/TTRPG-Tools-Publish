export const ZM_BEGIN_JS = "// BEGIN TTRPGTOOLS_ZOOMMAP_PUBLISH";
export const ZM_END_JS = "// END TTRPGTOOLS_ZOOMMAP_PUBLISH";

export const ZM_BEGIN_CSS = "/* BEGIN TTRPGTOOLS_ZOOMMAP_PUBLISH */";
export const ZM_END_CSS = "/* END TTRPGTOOLS_ZOOMMAP_PUBLISH */";

function escapeForJsComment(s: string): string {
  return String(s).replace(/\*\//g, "* /");
}

export function buildPublishCssBlock(opts?: {
  hoverPopoverMaxWidth?: string;
}): string {
  const popW = String(opts?.hoverPopoverMaxWidth ?? "720px").trim() || "720px";

  return [
    ZM_BEGIN_CSS,
    "",
    "/* ZoomMap Publish runtime CSS (generated). */",
    ":root{--ttrpgtools-hover-popover-max-width:" + popW + ";}",
    ".zm-root{position:relative;width:100%;height:480px;background:var(--background-secondary,#1e1e1e);border:1px solid var(--background-modifier-border,#444);border-radius:6px;overflow:hidden;}",
    ".zm-viewport{position:absolute;inset:0;overflow:hidden;touch-action:none;background:var(--background-primary,#111);}",
    "",
    "/* Viewport frame (optional) */",
    ".zm-root.zm-root--framepad{background:transparent;border:none;}",
    ".zm-root.zm-root--framepad .zm-viewport{border:1px solid var(--background-modifier-border,#444);border-radius:6px;}",
    ".zm-frame-layer{position:absolute;inset:0;pointer-events:none;z-index:40;}",
    ".zm-viewport-frame{position:absolute;inset:0;width:100%;height:100%;object-fit:fill;object-position:center;pointer-events:none;user-select:none;-webkit-user-drag:none;}",
    "",
    ".zm-hud-layer{position:absolute;inset:0;pointer-events:none;z-index:60;}",
	".zm-world{position:absolute;left:0;top:0;transform-origin:0 0;will-change:transform;}",
    ".zm-image{display:block;user-select:none;-webkit-user-drag:none;pointer-events:none;}",
    ".zm-overlays{position:absolute;left:0;top:0;pointer-events:none;}",
    ".zm-overlay-image{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:fill;pointer-events:none;user-select:none;-webkit-user-drag:none;}",
    ".zm-markers{position:absolute;left:0;top:0;}",
	".zm-hud-markers{position:absolute;inset:0;pointer-events:none;z-index:25;}",
    ".zm-marker{position:absolute;transform-origin:0 0;cursor:pointer;user-select:none;touch-action:none;}",
    ".zm-hud-marker{position:absolute;transform-origin:0 0;pointer-events:auto;cursor:pointer;touch-action:none;user-select:none;z-index:30;}",
	".zm-marker-inv{transform-origin:0 0;}",
    ".zm-marker-anchor{transform-origin:0 0;}",
    ".zm-marker-icon{pointer-events:none;user-select:none;-webkit-user-drag:none;display:block;}",
    ".zm-hidden{display:none!important;}",
    "",
    "/* Tooltip */",
    ".zm-tooltip{position:absolute;z-index:9999;max-width:360px;max-height:260px;overflow:auto;background:var(--background-primary,#111);border:1px solid var(--background-modifier-border,#444);border-radius:6px;padding:8px;box-shadow:0 8px 24px rgba(0,0,0,0.35);display:none;}",
    ".zm-tooltip.zm-tooltip-visible{display:block;}",
    ".zm-tooltip__title{font-weight:600;margin-bottom:6px;}",
    ".zm-tooltip__body{white-space:pre-wrap;}",
    "",
    "/* Context menu */",
    ".zm-menu,.zm-submenu{position:fixed;z-index:10000;min-width:220px;max-width:340px;background:var(--background-primary,#111);border:1px solid var(--background-modifier-border,#444);border-radius:6px;box-shadow:0 10px 28px rgba(0,0,0,0.45);padding:4px;user-select:none;}",
    ".zm-submenu{z-index:10001;}",
    ".zm-menu__sep{height:1px;margin:4px;background:var(--background-modifier-border,#444);}",
    ".zm-menu__item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:4px;color:var(--text-normal,#ddd);}",
    ".zm-menu__item:hover{background:var(--background-modifier-hover,rgba(255,255,255,0.06));}",
    ".zm-menu__label{flex:1;white-space:nowrap;text-align:left;}",
    ".zm-menu__right{display:inline-flex;align-items:center;gap:8px;}",
    ".zm-menu__check{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;color:var(--text-accent,#6aa9ff);font-size:16px;}",
    ".zm-menu__arrow{color:var(--text-muted,#aaa);}",
    ".zm-menu__icon{width:18px;height:18px;object-fit:contain;}",
    "",
    "/* Obsidian Publish hover popovers must be above viewport frames. */",
    ".popover.hover-popover{z-index:9990!important;}",
    ".hover-popover{z-index:9990!important;}",
    "",
    "/* Publish hover popover sizing (configurable via plugin settings) */",
    ".popover.hover-popover,.hover-popover{",
    "  --popover-width:min(var(--ttrpgtools-hover-popover-max-width,720px),92vw);",
    "  width:var(--popover-width)!important;",
    "  max-width:var(--popover-width)!important;",
	"  max-height:92vh!important;",
    "  height:auto!important;",
    "  overflow:hidden!important;",
    "  display:flex!important;",
    "  flex-direction:column!important;",
    "}",
    "",
    ".popover.hover-popover .hover-popover-content,",
    ".hover-popover .hover-popover-content,",
    ".popover.hover-popover .popover-content,",
    ".hover-popover .popover-content,",
    ".popover.hover-popover .markdown-preview-view,",
    ".hover-popover .markdown-preview-view,",
    ".popover.hover-popover .markdown-preview-section,",
    ".hover-popover .markdown-preview-section{",
    "  width:100%!important;",
    "  max-width:100%!important;",
    "  height:auto!important;",
    "  max-height:100%!important;",
    "}",
    "",
    ".popover.hover-popover .hover-popover-content,",
    ".hover-popover .hover-popover-content,",
    ".popover.hover-popover .popover-content,",
    ".hover-popover .popover-content{",
    "  flex:1 1 auto!important;",
    "  min-height:0!important;",
    "  overflow:auto!important;",
    "}",
    "",
    ".popover.hover-popover .markdown-preview-view,",
    ".hover-popover .markdown-preview-view,",
    ".popover.hover-popover .markdown-preview-section,",
    ".hover-popover .markdown-preview-section{",
    "  overflow:auto!important;",
    "}",
    "",
    "/* Measure overlay */",
    ".zm-measure{position:absolute;left:0;top:0;pointer-events:none;}",
    ".zm-measure__svg{width:100%;height:100%;overflow:visible;}",
    ".zm-measure__path{stroke:var(--zm-measure-color,var(--text-accent,#6aa9ff));stroke-width:var(--zm-measure-width,2px);fill:none;vector-effect:non-scaling-stroke;}",
    ".zm-measure__dot{fill:var(--zm-measure-color,var(--text-accent,#6aa9ff));stroke:var(--background-primary,#111);stroke-width:var(--zm-measure-width,2px);vector-effect:non-scaling-stroke;}",
    ".zm-measure-hud{position:absolute;left:8px;top:8px;z-index:20;background:var(--background-primary,#111);border:1px solid var(--background-modifier-border,#444);border-radius:6px;padding:4px 8px;box-shadow:0 8px 24px rgba(0,0,0,0.35);font-size:12px;white-space:pre-line;pointer-events:none;display:none;}",
    ".zm-measure-hud.zm-measure-hud-visible{display:block;}",
    "",
    "/* Drawings */",
    ".zm-draw{position:absolute;left:0;top:0;pointer-events:none;}",
    ".zm-draw__svg{width:100%;height:100%;overflow:visible;pointer-events:none;}",
    ".zm-draw__shape{vector-effect:non-scaling-stroke;pointer-events:none;}",
    ".zm-draw__label{font-size:12px;paint-order:stroke;stroke:var(--background-primary,#111);stroke-width:3px;}",
    "",
    "/* Text layers (static render only) */",
    ".zm-text{position:absolute;left:0;top:0;pointer-events:none;}",
    ".zm-text__svg{width:100%;height:100%;overflow:visible;pointer-events:none;}",	
    "",
    "/* Canvas base */",
    ".zm-canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;}",
    "",
    "/* =========================================================",
    "   Timeline Publish runtime CSS (generated).",
    "   Supports: ```timeline-cal and ```timeline-h",
    "   ========================================================= */",
    ".tl-controls{display:flex;gap:8px;align-items:center;margin:6px 0 10px;}",
    ".tl-controls button{font:inherit;padding:6px 10px;border-radius:6px;border:1px solid var(--background-modifier-border,#444);background:var(--background-primary,#111);color:var(--text-normal,#ddd);}",
    ".tl-controls button:hover{background:var(--background-modifier-hover,rgba(255,255,255,0.06));}",
    "",
    ".tl-wrapper.tl-cross-mode{display:grid;gap:20px;}",
    ".tl-row{width:100%;margin:0;}",
    ".tl-grid{display:grid;align-items:center;column-gap:0;row-gap:0;}",
    ".tl-grid.has-media{grid-template-columns:var(--tl-media-w,200px) 1fr;grid-template-areas:'media box';}",
    ".tl-row.tl-align-right .tl-grid.has-media{grid-template-columns:1fr var(--tl-media-w,200px);grid-template-areas:'box media';}",
    ".tl-grid.no-media{grid-template-columns:1fr;grid-template-areas:'box';}",
    ".tl-media{grid-area:media;position:relative;overflow:hidden;border-radius:8px;background:var(--background-modifier-border,#444);z-index:2;}",
    ".tl-box{grid-area:box;position:relative;box-sizing:border-box;padding:10px 12px;margin:0;background:var(--tl-bg,var(--background-primary,#111));border:1px solid var(--tl-accent,var(--background-modifier-border,#444));border-radius:10px;display:flex;flex-direction:column;overflow:hidden;}",
    ".tl-row:not(.tl-align-right) .tl-box.has-media{border-left:none;border-top-left-radius:0;border-bottom-left-radius:0;}",
    ".tl-row.tl-align-right .tl-box.has-media{border-right:none;border-top-right-radius:0;border-bottom-right-radius:0;}",
    ".tl-box h1,.tl-box h4{margin:0 0 6px;}",
    ".tl-title{font-size:1.3em;line-height:1.15;}",
    ".tl-date{opacity:.85;font-weight:600;}",
    ".tl-summary{line-height:1.4;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word;}",
    ".tl-summary.tl-clamp{max-height:calc(var(--tl-summary-lines,6) * 1.4em);}",
    ".tl-hover-anchor.internal-link{position:absolute;inset:0;z-index:5;text-decoration:none!important;color:transparent!important;background:transparent;cursor:pointer;}",
    ".tl-media:hover + .tl-box,.tl-box:hover{background:var(--tl-hover,var(--background-modifier-hover,rgba(255,255,255,0.06)));}",
    "",
    "/* Horizontal */",
    ".tl-h-scroller{--tl-h-col-w:600px;--tl-h-gap:0px;--tl-h-stack-gap:26px;overflow-x:auto;overflow-y:visible;-webkit-overflow-scrolling:touch;padding-bottom:8px;}",
    ".tl-h-content.tl-h-mixed{display:flex;flex-direction:row;align-items:stretch;gap:var(--tl-h-gap,0px);}",
    ".tl-h-content.tl-h-stacked{display:flex;flex-direction:column;gap:var(--tl-h-stack-gap,26px);}",
    ".tl-h-item{flex:0 0 auto;width:var(--tl-h-col-w,600px);padding-left:0!important;padding-right:0!important;}",
    ".tl-h-item .tl-grid.no-media{grid-template-columns:var(--tl-h-col-w,600px);}",
    ".tl-h-item .tl-grid.has-media{grid-template-columns:var(--tl-media-w,200px) max(160px,calc(var(--tl-h-col-w,600px) - var(--tl-media-w,200px)));}",
    ".tl-h-item.tl-align-right .tl-grid.has-media{grid-template-columns:max(160px,calc(var(--tl-h-col-w,600px) - var(--tl-media-w,200px))) var(--tl-media-w,200px);}",
    ".tl-h-timeline{display:block;}",
    ".tl-h-row{display:grid;grid-template-columns:repeat(var(--tl-h-cols,1),var(--tl-h-col-w,600px));column-gap:var(--tl-h-gap,0px);row-gap:12px;align-items:start;}",
    ".tl-h-slot{grid-column-start:var(--tl-h-col);display:flex;flex-direction:column;gap:12px;}",
    "",
    "@media (max-width:900px){",
    "  .tl-h-scroller{--tl-h-col-w:420px;}",
    "  .tl-grid.has-media{grid-template-columns:1fr!important;grid-template-areas:'media' 'box'!important;}",
    "  .tl-media{width:100%!important;height:auto!important;border-radius:10px 10px 0 0;}",
    "  .tl-media img{width:100%;height:auto!important;object-fit:cover;display:block;border-radius:10px 10px 0 0;}",
    "  .tl-box.has-media{border-radius:0 0 10px 10px;border:1px solid var(--tl-accent,var(--background-modifier-border,#444));border-top:none;}",
    "}",
    "",
    ZM_END_CSS,
    "",
  ].join("\n");
}

export function buildPublishJsBlock(
  buildStamp: string,
  opts?: {
    hideNavFolders?: string[];
    mapRoot?: string;
    timelineRoot?: string;
    hoverPopoverMaxWidth?: string;
  },
): string {
  const hideNavFolders = Array.isArray(opts?.hideNavFolders) ? (opts?.hideNavFolders ?? []) : [];
  const mapRoot = String(opts?.mapRoot ?? "ZoomMap/publish").trim() || "ZoomMap/publish";
  const timelineRoot = String(opts?.timelineRoot ?? "Timeline/publish").trim() || "Timeline/publish";
  const hoverPopoverMaxWidth = String(opts?.hoverPopoverMaxWidth ?? "720px").trim() || "720px";
  const js = [
    ZM_BEGIN_JS,
    "",
    "/* ZoomMap Publish runtime (generated). Build: " + escapeForJsComment(buildStamp) + " */",
    "(function(){",
    "  'use strict';",
    "",
    "  // Publish data note locations (generated, configurable via plugin settings)",
    "  var MAP_ROOT = " + JSON.stringify(mapRoot) + ";",
    "  var LIB_NOTE = MAP_ROOT + '/library';",
    "  var MARKERS_PREFIX = MAP_ROOT + '/markers/m-';",
    "",
    "  var TL_ROOT = " + JSON.stringify(timelineRoot) + ";",
    "  var TL_PREFIX = TL_ROOT + '/timelines/t-';",
    "",
    "  var HOVER_POPOVER_MAX_WIDTH = " + JSON.stringify(hoverPopoverMaxWidth) + ";",
    "  var HIDE_NAV_FOLDERS = " + JSON.stringify(hideNavFolders) + ";",
    "",
    "  var STATE = window.__TTRPG_ZOOMMAP_PUBLISH__ || (window.__TTRPG_ZOOMMAP_PUBLISH__ = {",
    "    inited: new WeakSet(),",
    "    libraryPromise: null,",
    "    library: null,",
    "    textCache: new Map(),",
    "    noteJsonCache: new Map(),",
    "    tintedSvgCache: new Map(),",
    "    raf: 0",
    "  });",
    "",
    "  var SITE_BASE = (function(){",
    "    var origin = window.location.origin;",
    "    var host = window.location.hostname;",
    "    if(host === ('publish' + '.' + 'obsidian' + '.md')){",
    "      var seg = (window.location.pathname.split('/').filter(Boolean)[0] || '').trim();",
    "      if(seg) return origin + '/' + seg + '/';",
    "    }",
    "    return origin + '/';",
    "  })();",
    "",
    "  function clamp(n,min,max){return Math.min(Math.max(n,min),max);}",
    "  function isNum(x){return typeof x==='number' && isFinite(x);}",
    "  function isLikelyMobile(){",
    "    try{",
    "      var ua = (navigator && navigator.userAgent) ? navigator.userAgent : '';",
    "      if(/Mobi|Android|iPhone|iPad|iPod/i.test(ua)) return true;",
    "      if(window.matchMedia){",
    "        if(window.matchMedia('(pointer: coarse)').matches) return true;",
    "        if(window.matchMedia('(max-width: 820px)').matches) return true;",
    "      }",
    "    }catch(_e){}",
    "    return false;",
    "  }",
    "",
    "  var HIDDEN_LAYER_PREFIXES = ['hidden','hide','secret'];",
    "  function isHiddenLayerName(name){",
    "    var s = String(name||'').trim().toLowerCase();",
    "    if(!s) return false;",
    "    for(var i=0;i<HIDDEN_LAYER_PREFIXES.length;i++){",
    "      var p = HIDDEN_LAYER_PREFIXES[i];",
    "      if(s === p) return true;",
    "      if(s.startsWith(p)){",
    "        var ch = s.charAt(p.length);",
    "        // Hide..., Hidden - DM, Secret: etc. (but not 'hideout')",
    "        if(ch && !/[a-z0-9]/i.test(ch)) return true;",
    "      }",
    "    }",
    "    return false;",
    "  }",
    "  function stripQuotes(s){",
    "    var t=(s||'').trim();",
    "    if((t.startsWith('\"') && t.endsWith('\"')) || (t.startsWith(\"'\") && t.endsWith(\"'\"))) return t.slice(1,-1);",
    "    return t;",
    "  }",
    "",
    "  function stripQuotePrefix(line){",
    "    var s=line||'';",
    "    for(;;){",
    "      var m=/^\\s*>\\s*/.exec(s);",
    "      if(!m) break;",
    "      s=s.slice(m[0].length);",
    "    }",
    "    return s;",
    "  }",
    "",
    "  function normalizeNavPrefix(s){",
    "    var p=String(s||'').trim();",
    "    if(!p) return '';",
    "    p=p.replace(/\\\\/g,'/');",
    "    p=p.replace(/^\\/+/, '');",
    "    p=p.replace(/\\/{2,}/g,'/');",
    "    p=p.replace(/\\/+$/, '');",
    "    return p.toLowerCase();",
    "  }",
    "  function shouldHideNavPath(path){",
    "    var p=normalizeNavPrefix(path);",
    "    if(!p) return false;",
    "    for(var i=0;i<HIDE_NAV_FOLDERS.length;i++){",
    "      var pref=normalizeNavPrefix(HIDE_NAV_FOLDERS[i]);",
    "      if(!pref) continue;",
    "      if(p===pref) return true;",
    "      if(p.startsWith(pref + '/')) return true;",
    "    }",
    "    return false;",
    "  }",
    "  function closestNavRoot(){",
    "    return document.querySelector('.site-body-left-column')",
    "      || document.querySelector('.nav-view')",
    "      || document.querySelector('nav');",
    "  }",
    "  function applyNavHiding(){",
    "    if(!HIDE_NAV_FOLDERS || !HIDE_NAV_FOLDERS.length) return;",
    "    var root=closestNavRoot();",
    "    if(!root) return;",
    "",
    "    var nodes=root.querySelectorAll('[data-path]');",
    "    for(var i=0;i<nodes.length;i++){",
    "      var el=nodes[i];",
    "      var dp=el.getAttribute('data-path');",
    "      if(!dp) continue;",
    "      if(shouldHideNavPath(dp)){",
    "        el.style.display='none';",
    "      }",
    "    }",
    "",
    "    var links=root.querySelectorAll('a.internal-link[data-href]');",
    "    for(var j=0;j<links.length;j++){",
    "      var a=links[j];",
    "      var href=a.getAttribute('data-href') || '';",
    "      href=stripWikiBrackets(href);",
    "      if(shouldHideNavPath(href)){",
    "        var row=a.closest('li') || a.closest('.tree-item') || a;",
    "        if(row && row.style) row.style.display='none';",
    "      }",
    "    }",
    "  }",
    "",
    "  function normalizeForHash(input){",
    "    var s=String(input||'').trim();",
    "    if(s.startsWith('[[') && s.endsWith(']]')) s=s.slice(2,-2).trim();",
    "    s=s.replace(/\\\\/g,'/');",
    "    s=s.replace(/^\\.\\/+/, '');",
    "    s=s.replace(/\\/{2,}/g,'/');",
    "    s=s.replace(/^\\/+/, '');",
    "    return s;",
    "  }",
    "",
    "  function fnv1a32(str){",
    "    var h=0x811c9dc5;",
    "    for(var i=0;i<str.length;i++){",
    "      h ^= str.charCodeAt(i);",
    "      h = Math.imul(h, 0x01000193);",
    "    }",
    "    return (h>>>0);",
    "  }",
    "",
    "  function hashPathToId(path){",
    "    return fnv1a32(normalizeForHash(path)).toString(36);",
    "  }",
    "",
    "  function hashKeyToId(key){",
    "    var s = String(key||'').trim().toLowerCase();",
    "    return fnv1a32(s).toString(36);",
    "  }",
    "",
    "  function encodeRoutePath(p){",
    "    var parts = String(p || '').split('/');",
    "    for(var i=0;i<parts.length;i++){",
    "      var seg = parts[i];",
    "      if(!seg) continue;",
    "      // If user already put percent escapes in the segment, keep them (avoid double encoding).",
    "      if(seg.indexOf('%') >= 0){",
    "        parts[i] = seg.replace(/ /g, '+');",
    "      } else {",
    "        // Publish commonly uses '+' for spaces in routes/assets",
    "        parts[i] = encodeURIComponent(seg).replace(/%20/g, '+');",
    "      }",
    "    }",
    "    return parts.join('/');",
    "  }",
    "",
    "  function resolveUrl(path){",
    "    if(!path) return '';",
    "    if(/^data:/.test(path)) return path;",
    "    if(/^https?:\\/\\//i.test(path)) return path;",
    "    var p = String(path).trim();",
    "    p = p.replace(/\\\\/g, '/');",
    "    p = p.replace(/^\\/+/, '');",
    "    p = p.replace(/\\/{2,}/g, '/');",
    "    p = encodeRoutePath(p);",
    "    try{ return new URL(p, SITE_BASE).toString(); }catch(_e){ return SITE_BASE + p; }",
    "  }",
    "  function resolveAssetUrl(vaultPath, useAltEncoding){",
    "    if(!vaultPath) return '';",
    "    var p = String(vaultPath).trim();",
    "    if(/^data:/.test(p)) return p;",
    "    if(/^https?:\\/\\//i.test(p)) return p;",
    "    p = p.replace(/\\\\/g, '/');",
    "    p = p.replace(/^\\/+/, '');",
    "    p = p.replace(/\\/{2,}/g, '/');",
    "    var accessBase = getAccessBaseUrl();",
    "    if(accessBase){",
    "      // access endpoint usually uses %20 (encodeURI), but we keep an alt (+) encoding just in case",
    "      var enc = useAltEncoding ? encodeRoutePath(p) : encodeURI(p);",
    "      return accessBase + enc;",
    "    }",
    "    // fallback: site route resolver (may be blocked by CSP for images, but better than nothing)",
    "    return resolveUrl(p);",
    "  }",
    "  function stripWikiBrackets(s){",
    "    var t = String(s||'').trim();",
    "    if(t.startsWith('[[') && t.endsWith(']]')) return t.slice(2,-2).trim();",
    "    return t;",
    "  }",
    "",
    "  function stripMdExt(p){",
    "    var s = String(p||'');",
    "    return s.toLowerCase().endsWith('.md') ? s.slice(0, -3) : s;",
    "  }",
    "",
    "  function resolveNoteHref(link){",
    "    // NOTE ROUTES in Publish use normal URL encoding (%20), not '+' like some assets.",
    "    var t = stripWikiBrackets(link);",
    "    var parts = t.split('#');",
    "    var path = (parts[0] || '').trim();",
    "    var frag = parts.length > 1 ? parts.slice(1).join('#') : '';",
    "    path = path.replace(/\\\\/g,'/');",
    "    path = path.replace(/^\\/+/, '');",
    "    path = path.replace(/\\/{2,}/g,'/');",
    "    path = stripMdExt(path);",
    "    var href = '';",
    "    try{ href = new URL(encodeURI(path), SITE_BASE).toString(); }catch(_e){ href = SITE_BASE + encodeURI(path); }",
    "    if(frag){ href += '#' + encodeURIComponent(frag); }",
    "    return href;",
    "  }",
    "",
    "  function fetchTextCached(url){",
    "    if(STATE.textCache.has(url)) return STATE.textCache.get(url);",
    "    var p = fetch(url, { credentials: 'include' }).then(function(r){",
    "      if(!r.ok) throw new Error('HTTP '+r.status+' '+r.statusText);",
    "      return r.text();",
    "    });",
    "    STATE.textCache.set(url, p);",
    "    return p;",
    "  }",
    "",
    "  function getAccessBaseUrl(){",
    "    var si = window.siteInfo || {};",
    "    var host = (si.host || '').trim();",
    "    var uid = (si.uid || '').trim();",
    "    if(!host || !uid) return '';",
    "    if(!/^https?:\\/\\//i.test(host)) host = 'https://' + host;",
    "    if(!host.endsWith('/')) host += '/';",
    "    return host + 'access/' + uid + '/';",
    "  }",
    "",
    "  function notePathToMdPath(notePath){",
    "    var p = String(notePath||'').trim();",
    "    if(p.startsWith('[[') && p.endsWith(']]')) p = p.slice(2,-2).trim();",
    "    // remove fragment/query",
    "    p = p.split('#')[0].split('?')[0];",
    "    p = p.replace(/\\\\/g,'/');",
    "    p = p.replace(/^\\/+/, '');",
    "    p = p.replace(/\\/{2,}/g,'/');",
    "    if(!p.toLowerCase().endsWith('.md')) p += '.md';",
    "    return p;",
    "  }",
    "  function stripLineNumbersIfPresent(text){",
    "    var s = String(text||'');",
    "    var lines = s.split('\\n');",
    "    var sample = [];",
    "    for(var i=0;i<lines.length && sample.length<8;i++){",
    "      var t = lines[i].trim();",
    "      if(t) sample.push(lines[i]);",
    "    }",
    "    if(sample.length < 3) return s;",
    "    var hits = 0;",
    "    for(var j=0;j<sample.length;j++){",
    "      if(/^\\s*\\d+\\s+/.test(sample[j])) hits++;",
    "    }",
    "    if(hits >= Math.ceil(sample.length * 0.6)){",
    "      for(var k=0;k<lines.length;k++){",
    "        lines[k] = lines[k].replace(/^\\s*\\d+\\s+/, '');",
    "      }",
    "      return lines.join('\\n');",
    "    }",
    "    return s;",
    "  }",
    "",
    "  function tryParseJsonFromText(raw){",
    "    var t = stripLineNumbersIfPresent(raw);",
    "    var s = String(t||'').trim();",
    "    if(!s) return null;",
    "    // fast reject",
    "    var c0 = s[0];",
    "    if(c0 !== '{' && c0 !== '[') return null;",
    "    try{ return JSON.parse(s); }catch(_e){ return null; }",
    "  }",
    "  function extractJsonFromMarkdown(md){",
    "    var text = String(md||'');",
    "    var blocks = [];",
    "",
    "    // Prefer ```json fences",
    "    var re = /```json\\s*([\\s\\S]*?)```/ig;",
    "    var m;",
    "    while((m = re.exec(text))){",
    "      if(m[1]) blocks.push(m[1]);",
    "    }",
    "",
    "    // Fallback: any fenced block that looks like JSON",
    "    if(blocks.length === 0){",
    "      var re2 = /```\\s*([\\s\\S]*?)```/g;",
    "      while((m = re2.exec(text))){",
    "        if(m[1]) blocks.push(m[1]);",
    "      }",
    "    }",
    "",
    "    var bestObj = null; var bestLen = 0;",
    "    for(var i=0;i<blocks.length;i++){",
    "      var raw = blocks[i];",
    "      var obj = tryParseJsonFromText(raw);",
    "      if(!obj) continue;",
    "      var len = String(raw||'').length;",
    "      if(len > bestLen){ bestLen = len; bestObj = obj; }",
    "    }",
    "    if(bestObj) return bestObj;",
    "    throw new Error('No JSON payload found in markdown (no parseable fenced JSON block).');",
    "  }",	
    "",
    "  function extractJsonFromNoteHtml(html){",
    "    var doc = new DOMParser().parseFromString(String(html||''), 'text/html');",
    "",
    "    // Collect candidates in priority order",
    "    var candidates = [];",
    "",
    "    // 1) Any <pre> blocks (Publish often renders fenced code blocks into <pre>)",
    "    var pres = doc.querySelectorAll('pre');",
    "    for(var i=0;i<pres.length;i++){",
    "      var txt = pres[i].textContent || '';",
    "      if(txt) candidates.push(txt);",
    "    }",
    "",
    "    // 2) Fallback: any <code> blocks (some themes wrap differently)",
    "    var codes = doc.querySelectorAll('code');",
    "    for(var j=0;j<codes.length;j++){",
    "      var txt2 = codes[j].textContent || '';",
    "      if(txt2) candidates.push(txt2);",
    "    }",
    "",
    "    // 3) Last resort: look for fenced ```json ... ``` inside the raw HTML (in case Publish embeds raw markdown somewhere)",
    "    if(candidates.length === 0){",
    "      var m = /```json\\s*([\\s\\S]*?)```/i.exec(String(html||''));",
    "      if(m && m[1]) candidates.push(m[1]);",
    "    }",
    "",
    "    var bestObj = null;",
    "    var bestLen = 0;",
    "    for(var k=0;k<candidates.length;k++){",
    "      var raw = candidates[k];",
    "      var obj = tryParseJsonFromText(raw);",
    "      if(!obj) continue;",
    "      var len = String(raw||'').length;",
    "      if(len > bestLen){ bestLen = len; bestObj = obj; }",
    "    }",
    "",
    "    if(bestObj) return bestObj;",
    "",
    "    // Debug hint (helps users diagnose Publish rendering differences)",
    "    throw new Error('No JSON payload found in note HTML (no parseable <pre>/<code> JSON).');",
    "  }",
    "",
    "  function fetchNoteJson(notePath){",
    "    var mdPath = notePathToMdPath(notePath);",
    "    var accessBase = getAccessBaseUrl();",
    "    if(accessBase){",
    "      // IMPORTANT: access endpoint expects URL-encoded path but keeps slashes",
    "      var accessUrl = accessBase + encodeURI(mdPath);",
    "      if(STATE.noteJsonCache.has(accessUrl)) return STATE.noteJsonCache.get(accessUrl);",
    "      var p = fetchTextCached(accessUrl).then(function(md){",
    "        return extractJsonFromMarkdown(md);",
    "      });",
    "      STATE.noteJsonCache.set(accessUrl, p);",
    "      return p;",
    "    }",
    "",
    "    // Fallback: try to fetch the note HTML route (may not contain content on Publish SPA)",
    "    var url = resolveUrl(String(notePath||'').trim());",
    "    if(STATE.noteJsonCache.has(url)) return STATE.noteJsonCache.get(url);",
    "    var p2 = fetchTextCached(url).then(function(html){ return extractJsonFromNoteHtml(html); });",
    "    STATE.noteJsonCache.set(url, p2);",
    "    return p2;",
    "  }",
    "",
    "  function ensureLibrary(){",
    "    if(STATE.libraryPromise) return STATE.libraryPromise;",
    "    STATE.libraryPromise = fetchNoteJson(LIB_NOTE).then(function(obj){",
    "      STATE.library = obj || { icons: [], baseCollections: [] };",
    "      return STATE.library;",
    "    }).catch(function(err){",
    "      console.warn('ZoomMap Publish: library note load failed', err);",
    "      STATE.library = { icons: [], baseCollections: [] };",
    "      return STATE.library;",
    "    });",
    "    return STATE.libraryPromise;",
    "  }",
    "",
    "  function parseZoomFactor(v, fallback){",
    "    if(typeof v==='number' && isFinite(v) && v>0) return v;",
    "    if(typeof v==='string'){",
    "      var s=v.trim();",
    "      if(!s) return fallback;",
    "      var pct=false;",
    "      if(s.endsWith('%')){pct=true; s=s.slice(0,-1).trim();}",
    "      s=s.replace(',', '.');",
    "      var n=Number(s);",
    "      if(isFinite(n) && n>0) return pct ? (n/100) : n;",
    "    }",
    "    return fallback;",
    "  }",
    "",
    "  // YAML subset parser (same as before, plus markersPath kept as original string)",
    "  function parseZoommapYaml(raw){",
    "    var lines = String(raw||'').split('\\n').map(function(ln){return stripQuotePrefix(ln);});",
    "    while(lines.length && !lines[0].trim()) lines.shift();",
    "    while(lines.length && !lines[lines.length-1].trim()) lines.pop();",
    "",
    "    var scalars = {};",
    "    var blocks = {};",
    "    var i=0;",
    "    function isTopKey(ln){",
    "      if(!ln) return false;",
    "      if(/^\\s+#/.test(ln)) return false;",
    "      return /^([A-Za-z0-9_-]+)\\s*:\\s*(.*)$/.test(ln) && (/^\\S/.test(ln));",
    "    }",
    "    while(i<lines.length){",
    "      var ln=lines[i];",
    "      if(!ln.trim() || ln.trim().startsWith('#')){ i++; continue; }",
    "      var m=/^([A-Za-z0-9_-]+)\\s*:\\s*(.*)$/.exec(ln);",
    "      if(!m){ i++; continue; }",
    "      var key=m[1];",
    "      var rest=(m[2]||'').trim();",
    "      i++;",
    "      if(rest){ scalars[key]=rest; continue; }",
    "      var block=[];",
    "      while(i<lines.length){",
    "        var nx=lines[i];",
    "        if(isTopKey(nx)) break;",
    "        block.push(nx);",
    "        i++;",
    "      }",
    "      blocks[key]=block;",
    "    }",
    "",
    "    function parseBool(s){",
    "      var t=(s||'').trim().toLowerCase();",
    "      if(t==='true') return true;",
    "      if(t==='false') return false;",
    "      return undefined;",
    "    }",
    "",
    "    function parseListBlock(block){",
    "      var out=[];",
    "      var j=0;",
    "      while(j<block.length){",
    "        var ln=block[j];",
    "        if(!ln.trim() || ln.trim().startsWith('#')){ j++; continue; }",
    "        var t=ln.trim();",
    "        if(!t.startsWith('-')){ j++; continue; }",
    "        var after=t.slice(1).trim();",
    "        if(!after){ j++; continue; }",
    "        var mm=/^path\\s*:\\s*(.+)$/.exec(after);",
    "        if(mm){",
    "          var obj={ path: stripQuotes(mm[1]||'') };",
    "          j++;",
    "          while(j<block.length){",
    "            var ln2=block[j];",
    "            if(!ln2.trim() || ln2.trim().startsWith('#')){ j++; continue; }",
    "            if(ln2.trim().startsWith('-')) break;",
    "            var mm2=/^\\s*([A-Za-z0-9_-]+)\\s*:\\s*(.*)$/.exec(ln2);",
    "            if(mm2){",
    "              var k2=mm2[1];",
    "              var v2=(mm2[2]||'').trim();",
    "              if(k2==='name') obj.name=stripQuotes(v2);",
    "              if(k2==='visible'){",
    "                var b=parseBool(v2);",
    "                if(typeof b==='boolean') obj.visible=b;",
    "              }",
    "            }",
    "            j++;",
    "          }",
    "          out.push(obj);",
    "          continue;",
    "        }",
    "        out.push(stripQuotes(after));",
    "        j++;",
    "      }",
    "      return out;",
    "    }",
    "",
    "    var image = stripQuotes(scalars.image || '');",
    "    var markers = stripQuotes(scalars.markers || '');",
    "    var render = stripQuotes(scalars.render || '');",
    "    var width = stripQuotes(scalars.width || '');",
    "    var height = stripQuotes(scalars.height || '');",
    "    var responsive = parseBool(scalars.responsive);",
    "    var widthFromYaml = Object.prototype.hasOwnProperty.call(scalars, 'width');",
    "    var heightFromYaml = Object.prototype.hasOwnProperty.call(scalars, 'height');",
    "",
    "    var imageBases = blocks.imageBases ? parseListBlock(blocks.imageBases) : [];",
    "    var imageOverlays = blocks.imageOverlays ? parseListBlock(blocks.imageOverlays) : [];",
    "    if(!image && imageBases.length){",
    "      var first=imageBases[0];",
    "      if(typeof first==='string') image=first;",
    "      else if(first && typeof first==='object' && typeof first.path==='string') image=first.path;",
    "    }",
    "    if(!markers && image) markers = image + '.markers.json';",
    "",
    "    var minZoom = parseZoomFactor(scalars.minZoom, 0.25);",
    "    var maxZoom = parseZoomFactor(scalars.maxZoom, 8);",
    "",
    "    var rm = (render||'').toLowerCase();",
    "    var renderMode = (rm==='canvas' ? 'canvas' : 'dom');",
    "",
    "    var viewportFrame = stripQuotes(scalars.viewportFrame || '');",
    "    var viewportFrameInsets = null;",
    "    if(blocks.viewportFrameInsets){",
    "      // Very small YAML subset: unit + 4 numbers",
    "      var unit='framePx', top=0,right=0,bottom=0,left=0;",
    "      for(var k=0;k<blocks.viewportFrameInsets.length;k++){",
    "        var ln=blocks.viewportFrameInsets[k];",
    "        if(!ln || !ln.trim() || ln.trim().startsWith('#')) continue;",
    "        var mm=/^\\s*([A-Za-z0-9_-]+)\\s*:\\s*(.*)$/.exec(ln);",
    "        if(!mm) continue;",
    "        var kk=mm[1]; var vv=(mm[2]||'').trim();",
    "        if(kk==='unit'){ var u=stripQuotes(vv); if(u==='percent') unit='percent'; else unit='framePx'; }",
    "        if(kk==='top') top=Number(stripQuotes(vv).replace(',','.'))||0;",
    "        if(kk==='right') right=Number(stripQuotes(vv).replace(',','.'))||0;",
    "        if(kk==='bottom') bottom=Number(stripQuotes(vv).replace(',','.'))||0;",
    "        if(kk==='left') left=Number(stripQuotes(vv).replace(',','.'))||0;",
    "      }",
    "      viewportFrameInsets = { unit: unit, top: top, right: right, bottom: bottom, left: left };",
    "    }",
    "",
    "    return {",
    "      imagePath: image,",
    "      markersPath: markers,",
    "      markersNote: (MARKERS_PREFIX + hashPathToId(markers)),",
    "      minZoom: minZoom,",
    "      maxZoom: maxZoom,",
    "      width: width || '100%',",
    "      height: height || '480px',",
    "      renderMode: renderMode,",
    "      responsive: !!responsive,",
    "      widthFromYaml: !!widthFromYaml,",
    "      heightFromYaml: !!heightFromYaml,",
    "      imageBases: imageBases,",
    "      imageOverlays: imageOverlays,",
    "      viewportFrame: viewportFrame,",
    "      viewportFrameInsets: viewportFrameInsets",
    "    };",
    "  }",
    "",
    "  // ===== Minimal Publish map implementation (read-only) =====",
    "  function PublishMap(host, cfg, data, library){",
    "    this.host=host; this.cfg=cfg; this.data=data||{}; this.library=library||{};",
    "    this.isMobile=false; this.responsiveEffective=false;",	
    "    this.imgW=0; this.imgH=0; this.vw=0; this.vh=0;",
    "    this.scale=1; this.tx=0; this.ty=0;",
    "    this.dragging=false; this.lastX=0; this.lastY=0;",
    "    this.measuring=false; this.measurePts=[]; this.measurePreview=null;",
    "    this.menu=null; this.tooltip=null; this.tooltipTimer=0;",
    "    this.baseImg=null; this.baseCanvas=null; this.baseCtx=null;",
    "    this.frameLayerEl=null; this.frameImgEl=null; this.frameNaturalW=0; this.frameNaturalH=0;",
	"	 this.hudLayerEl=null;",
    "    this.drawEl=null; this.drawSvg=null; this.drawDefs=null; this.drawLayer=null;",
    "    this.textEl=null; this.textSvg=null; this.textLayer=null;",
    "    this.hudMarkersEl=null;",
    "    this.ro=null;",
    "  }",

    "  PublishMap.prototype.applyHostSize=function(){",
    "    // Always use responsive layout: width 100%, but cap the max width to the configured map width.",
    "    this.host.style.width = '100%';",
    "    this.host.style.aspectRatio = '';",
    "",
    "    var w = (this.cfg.width || '100%');",
    "    var h = (this.cfg.height || '480px');",
    "    var fr = (this.data && this.data.frame) ? this.data.frame : null;",
    "    if(fr && isNum(fr.w) && fr.w>=48 && !this.cfg.widthFromYaml){",
    "      w = Math.max(220, Math.round(fr.w)) + 'px';",
    "    }",
    "    if(fr && isNum(fr.h) && fr.h>=48 && !this.cfg.heightFromYaml){",
    "      h = Math.max(220, Math.round(fr.h)) + 'px';",
    "    }",
    "",
    "    // maxWidth only makes sense for absolute sizes; ignore percent-based widths.",
    "    var wTrim = String(w||'').trim();",
    "    if(wTrim && wTrim.indexOf('%') < 0){",
    "      this.host.style.maxWidth = wTrim;",
    "    }else{",
    "      this.host.style.maxWidth = '';",
    "    }",
    "",
    "    if(this.responsiveEffective){",
    "      // Try to avoid initial 0-height (absolute children). Use stored image size if available.",
    "      var sw=0, sh=0;",
    "      if(this.data && this.data.size && isNum(this.data.size.w) && isNum(this.data.size.h)){",
    "        sw=this.data.size.w; sh=this.data.size.h;",
    "      }",
    "      if(sw>0 && sh>0){",
    "        this.host.style.height = 'auto';",
    "        this.host.style.aspectRatio = sw + ' / ' + sh;",
    "      }else{",
    "        this.host.style.height = h;",
    "        this.host.style.aspectRatio = '';",
    "      }",
    "      return;",
    "    }",
    "",
    "    this.host.style.height = h;",
    "  };",

    "  PublishMap.prototype.updateResponsiveAspectRatio=function(){",
    "    if(!this.responsiveEffective) return;",
    "    if(!(this.imgW>0 && this.imgH>0)) return;",
    "    this.host.style.width = '100%';",
    "    this.host.style.height = 'auto';",
    "    this.host.style.aspectRatio = this.imgW + ' / ' + this.imgH;",
    "  };",	
    "",
    "  PublishMap.prototype.init=function(){",
    "    var self=this;",
    "    self.host.classList.add('zm-root');",
    "    self.isMobile = isLikelyMobile();",
    "    self.responsiveEffective = !!self.cfg.responsive;",
    "    self.applyHostSize();",
    "",
    "    self.viewportEl=document.createElement('div');",
    "    self.viewportEl.className='zm-viewport';",
    "    self.host.innerHTML='';",
    "    self.host.appendChild(self.viewportEl);",
    "",
    "    // Viewport frame (optional)",
    "    if(self.cfg.viewportFrame){",
    "      self.host.classList.add('zm-root--framepad');",
    "      self.frameLayerEl=document.createElement('div');",
    "      self.frameLayerEl.className='zm-frame-layer';",
    "      self.frameImgEl=document.createElement('img');",
    "      self.frameImgEl.className='zm-viewport-frame';",
    "      self.frameImgEl.decoding='async';",
    "      self.frameImgEl.src=resolveAssetUrl(self.cfg.viewportFrame, false);",
    "      self.frameLayerEl.appendChild(self.frameImgEl);",
    "      self.host.appendChild(self.frameLayerEl);",
    "    }",
    "",
    "    self.hudLayerEl=document.createElement('div');",
    "    self.hudLayerEl.className='zm-hud-layer';",
    "    self.host.appendChild(self.hudLayerEl);",
    "",
    "    if(self.cfg.renderMode==='canvas'){",
    "      self.baseCanvas=document.createElement('canvas');",
    "      self.baseCanvas.className='zm-canvas';",
    "      self.viewportEl.appendChild(self.baseCanvas);",
    "      self.baseCtx=self.baseCanvas.getContext('2d');",
    "    }",
    "",
    "    self.worldEl=document.createElement('div');",
    "    self.worldEl.className='zm-world';",
    "    self.viewportEl.appendChild(self.worldEl);",
    "",
    "    self.imgEl=document.createElement('img');",
    "    self.imgEl.className='zm-image';",
    "    self.worldEl.appendChild(self.imgEl);",
    "",
    "    self.overlaysEl=document.createElement('div');",
    "    self.overlaysEl.className='zm-overlays';",
    "    self.worldEl.appendChild(self.overlaysEl);",
    "",
    "    self.markersEl=document.createElement('div');",
    "    self.markersEl.className='zm-markers';",
    "    self.worldEl.appendChild(self.markersEl);",
    "",
    "    self.hudMarkersEl=document.createElement('div');",
    "    self.hudMarkersEl.className='zm-hud-markers';",
    "    self.hudLayerEl.appendChild(self.hudMarkersEl);",
    "",
    "    self.measureEl=document.createElement('div');",
    "    self.measureEl.className='zm-measure';",
    "    self.worldEl.appendChild(self.measureEl);",
    "",
    "    self.measureSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');",
    "    self.measureSvg.classList.add('zm-measure__svg');",
    "    self.measureEl.appendChild(self.measureSvg);",
    "    self.measurePath=document.createElementNS('http://www.w3.org/2000/svg','path');",
    "    self.measurePath.classList.add('zm-measure__path');",
    "    self.measureSvg.appendChild(self.measurePath);",
    "    self.measureDots=document.createElementNS('http://www.w3.org/2000/svg','g');",
    "    self.measureSvg.appendChild(self.measureDots);",
    "",
    "    self.measureHud=document.createElement('div');",
    "    self.measureHud.className='zm-measure-hud';",
    "    self.hudLayerEl.appendChild(self.measureHud);",
    "",
    "    // Drawings layer",
    "    self.drawEl=document.createElement('div');",
    "    self.drawEl.className='zm-draw';",
    "    self.worldEl.appendChild(self.drawEl);",
    "    self.drawSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');",
    "    self.drawSvg.classList.add('zm-draw__svg');",
    "    self.drawEl.appendChild(self.drawSvg);",
    "    self.drawDefs=document.createElementNS('http://www.w3.org/2000/svg','defs');",
    "    self.drawSvg.appendChild(self.drawDefs);",
    "    self.drawLayer=document.createElementNS('http://www.w3.org/2000/svg','g');",
    "    self.drawSvg.appendChild(self.drawLayer);",
    "",
    "    // Text layer (static render)",
    "    self.textEl=document.createElement('div');",
    "    self.textEl.className='zm-text';",
    "    self.worldEl.appendChild(self.textEl);",
    "    self.textSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');",
    "    self.textSvg.classList.add('zm-text__svg');",
    "    self.textEl.appendChild(self.textSvg);",
    "    self.textLayer=document.createElementNS('http://www.w3.org/2000/svg','g');",
    "    self.textSvg.appendChild(self.textLayer);",
    "",
    "    // events",
    "    self.viewportEl.addEventListener('wheel', function(e){",
    "      if(self.responsiveEffective) return;",
    "      e.preventDefault();",
    "      self.onWheel(e);",
    "    }, { passive:false });",
    "",
    "    self.viewportEl.addEventListener('dblclick', function(e){",
    "      if(self.responsiveEffective) return;",
    "      e.preventDefault();",
    "      self.zoomAt(e.clientX, e.clientY, 1.5);",
    "    });",
    "",
    "    self.viewportEl.addEventListener('pointerdown', function(e){",
    "      if(e.button!==0) return;",
    "      var tgt = e.target;",
    "      if(tgt && tgt.closest && tgt.closest('.zm-marker')) return;",
    "      if(tgt && tgt.closest && (tgt.closest('.zm-menu') || tgt.closest('.zm-submenu'))) return;",
    "      if(self.measuring){ self.addMeasurePointFromEvent(e); return; }",
	"      if(self.responsiveEffective) return;",
    "      self.dragging=true; self.lastX=e.clientX; self.lastY=e.clientY;",
    "      self.viewportEl.setPointerCapture(e.pointerId);",
    "    });",
    "",
    "    self.viewportEl.addEventListener('pointermove', function(e){",
    "      if(self.measuring) self.updateMeasurePreviewFromEvent(e);",
    "      if(self.responsiveEffective) return;",
    "      if(!self.dragging) return;",
    "      var dx=e.clientX-self.lastX, dy=e.clientY-self.lastY;",
    "      self.lastX=e.clientX; self.lastY=e.clientY;",
    "      self.panBy(dx,dy);",
    "    });",
    "",
    "    self.viewportEl.addEventListener('pointerup', function(_e){ self.dragging=false; });",
    "    self.host.addEventListener('contextmenu', function(e){ e.preventDefault(); self.openContextMenu(e.clientX,e.clientY); });",
    "",
    "    document.addEventListener('pointerdown', function(ev){",
    "      if(!self.menu) return;",
    "      var t=ev.target;",
    "      if(t && self.menu.contains(t)) return;",
    "      self.closeMenu();",
    "    }, true);",
    "",
    "    if('ResizeObserver' in window){",
    "      self.ro = new ResizeObserver(function(){ self.onResize(); });",
    "      self.ro.observe(self.host);",
    "    }",
    "",
    "    return self.ensureFrameNaturalSize().then(function(){",
    "      self.applyViewportInset();",
    "      return self.loadBase(self.getActiveBasePath());",
    "    }).then(function(){",
    "      self.applySizes();",
    "      self.fitToView();",
    "      self.updateHudPinsForResize(self.viewportEl.getBoundingClientRect());",
    "      self.renderOverlays();",
    "      self.renderMarkers();",
    "      self.renderDrawings();",
    "      self.renderTextLayers();",
    "      self.renderCanvas();",
    "      self.renderMeasure();",
    "    });",
    "  };",

    "  PublishMap.prototype.getBasesNormalized=function(){",
    "    var out=[];",
    "    var raw = (this.data && Array.isArray(this.data.bases)) ? this.data.bases : null;",
    "    var yaml = Array.isArray(this.cfg.imageBases) ? this.cfg.imageBases : [];",
    "    if(raw && raw.length){",
    "      for(var i=0;i<raw.length;i++){",
    "        var it=raw[i];",
    "        if(typeof it==='string'){ out.push({ path: it, name: '' }); }",
    "        else if(it && typeof it==='object' && typeof it.path==='string'){ out.push({ path: it.path, name: it.name||'' }); }",
    "      }",
    "    } else if(yaml && yaml.length){",
    "      for(var j=0;j<yaml.length;j++){",
    "        var y=yaml[j];",
    "        if(typeof y==='string') out.push({ path: y, name: '' });",
    "        else if(y && typeof y==='object' && typeof y.path==='string') out.push({ path: y.path, name: y.name||'' });",
    "      }",
    "    } else if(this.cfg.imagePath){",
    "      out.push({ path: this.cfg.imagePath, name: '' });",
    "    }",
    "    // de-dup by path",
    "    var seen={};",
    "    var uniq=[];",
    "    for(var k=0;k<out.length;k++){",
    "      var p=String(out[k].path||'').trim();",
    "      if(!p || seen[p]) continue;",
    "      seen[p]=true;",
    "      uniq.push(out[k]);",
    "    }",
    "    return uniq;",
    "  };",

    "  PublishMap.prototype.getActiveBasePath=function(){",
    "    var bases=this.getBasesNormalized();",
    "    var active=(this.data && typeof this.data.activeBase==='string' && this.data.activeBase.trim()) ? this.data.activeBase.trim() : '';",
    "    if(active){",
    "      for(var i=0;i<bases.length;i++){ if(bases[i].path===active) return active; }",
    "    }",
    "    return (bases[0] && bases[0].path) ? bases[0].path : (this.cfg.imagePath||'');",
    "  };",

    "  PublishMap.prototype.getOverlaysNormalized=function(){",
    "    var out=[];",
    "    var raw = (this.data && Array.isArray(this.data.overlays)) ? this.data.overlays : null;",
    "    var yaml = Array.isArray(this.cfg.imageOverlays) ? this.cfg.imageOverlays : [];",
    "    var src = (raw && raw.length) ? raw : yaml;",
    "    for(var i=0;i<src.length;i++){",
    "      var it=src[i];",
    "      if(typeof it==='string'){ out.push({ path: it, name:'', visible:false }); }",
    "      else if(it && typeof it==='object' && typeof it.path==='string'){",
    "        out.push({ path: it.path, name: it.name||'', visible: (it.visible===true) });",
    "      }",
    "    }",
    "    return out;",
    "  };",

    "  PublishMap.prototype.ensureFrameNaturalSize=function(){",
    "    var self=this;",
    "    if(!self.frameImgEl || !self.cfg.viewportFrame) return Promise.resolve();",
    "    return new Promise(function(resolve){",
    "      var img=self.frameImgEl;",
    "      if(img.complete && img.naturalWidth>0){ self.frameNaturalW=img.naturalWidth; self.frameNaturalH=img.naturalHeight; resolve(); return; }",
    "      img.onload=function(){ self.frameNaturalW=img.naturalWidth||0; self.frameNaturalH=img.naturalHeight||0; resolve(); };",
    "      img.onerror=function(){ resolve(); };",
    "    });",
    "  };",

    "  PublishMap.prototype.computeViewportInsetsPx=function(outerW, outerH){",
    "    var spec=this.cfg.viewportFrameInsets;",
    "    if(!this.cfg.viewportFrame || !spec) return { t:0,r:0,b:0,l:0 };",
    "    var unit = spec.unit==='percent' ? 'percent' : 'framePx';",
    "    var t=0,r=0,b=0,l=0;",
    "    if(unit==='percent'){",
    "      t = outerH * (Number(spec.top)||0) / 100;",
    "      b = outerH * (Number(spec.bottom)||0) / 100;",
    "      l = outerW * (Number(spec.left)||0) / 100;",
    "      r = outerW * (Number(spec.right)||0) / 100;",
    "    }else{",
    "      var fw=this.frameNaturalW||0, fh=this.frameNaturalH||0;",
    "      if(fw>0 && fh>0){",
    "        var sx=outerW/fw, sy=outerH/fh;",
    "        t = (Number(spec.top)||0) * sy;",
    "        b = (Number(spec.bottom)||0) * sy;",
    "        l = (Number(spec.left)||0) * sx;",
    "        r = (Number(spec.right)||0) * sx;",
    "      }",
    "    }",
    "    // clamp to keep minimum inner viewport",
    "    var minInnerW=64, minInnerH=64;",
    "    var sumX=l+r; var maxSumX=Math.max(0, outerW-minInnerW);",
    "    if(sumX>maxSumX && sumX>0){ var kx=maxSumX/sumX; l*=kx; r*=kx; }",
    "    var sumY=t+b; var maxSumY=Math.max(0, outerH-minInnerH);",
    "    if(sumY>maxSumY && sumY>0){ var ky=maxSumY/sumY; t*=ky; b*=ky; }",
    "    return {",
    "      t: Math.max(0, Math.round(t)),",
    "      r: Math.max(0, Math.round(r)),",
    "      b: Math.max(0, Math.round(b)),",
    "      l: Math.max(0, Math.round(l))",
    "    };",
    "  };",

    "  PublishMap.prototype.applyViewportInset=function(){",
    "    if(!this.cfg.viewportFrame || !this.viewportEl) return;",
    "    var rect=this.host.getBoundingClientRect();",
    "    var w=rect.width||1, h=rect.height||1;",
    "    var ins=this.computeViewportInsetsPx(w,h);",
    "    this.viewportEl.style.inset = ins.t+'px '+ins.r+'px '+ins.b+'px '+ins.l+'px';",
	"	 if(this.hudLayerEl){",
	"	   this.hudLayerEl.style.inset = ins.t+'px '+ins.r+'px '+ins.b+'px '+ins.l+'px';",
	"	  }",
    "  };",
    "",
    "  PublishMap.prototype.loadBase=function(path){",
	"    var self=this;",
    "    var url=resolveAssetUrl(path, false);",
    "    var urlAlt=resolveAssetUrl(path, true);",
    "    var triedAlt=false;",
    "    console.log('ZoomMap Publish: Base URL:', url, 'alt:', urlAlt, 'from path:', path, 'SITE_BASE:', (typeof SITE_BASE !== 'undefined' ? SITE_BASE : ''), 'accessBase:', getAccessBaseUrl());",
    "    return new Promise(function(resolve,reject){",
    "      var img=new Image();",
    "      img.decoding='async';",
    "      img.onload=function(){",
    "        self.imgW=img.naturalWidth||img.width||0;",
    "        self.imgH=img.naturalHeight||img.height||0;",
    "        self.baseImg=img;",
    "        self.imgEl.src=url;",
    "        if(self.responsiveEffective){",
    "          self.updateResponsiveAspectRatio();",
    "          if(self.cfg.viewportFrame) self.applyViewportInset();",
    "        }",
    "        resolve();",
    "      };",
    "      img.onerror=function(ev){",
    "        console.warn('ZoomMap Publish: base image failed to load', { path: path, url: url, alt: urlAlt, event: ev });",
    "        if(!triedAlt && urlAlt && urlAlt !== url){",
    "          triedAlt = true;",
    "          url = urlAlt;",
    "          console.warn('ZoomMap Publish: retry base image with alt url', urlAlt);",
    "          img.src = urlAlt;",
    "          self.imgEl.src = urlAlt;",
    "          return;",
    "        }",
    "        reject(new Error('Failed to load base image: '+path+' ('+url+')'));",
    "      };",
    "      img.src=url;",
    "    });",
    "  };",

    "  PublishMap.prototype.setActiveBase=function(path){",
    "    var self=this;",
    "    if(!path) return Promise.resolve();",
    "    if(!self.data) self.data={};",
    "    self.data.activeBase = path;",
    "    return self.loadBase(path).then(function(){",
    "      self.applySizes();",
    "      self.fitToView();",
    "      self.renderOverlays();",
    "      self.renderMarkers();",
    "      self.renderDrawings();",
    "      self.renderTextLayers();",
    "      self.renderCanvas();",
    "      self.renderMeasure();",
    "    });",
    "  };",
    "",
    "  PublishMap.prototype.applySizes=function(){",
    "    this.worldEl.style.width=this.imgW+'px';",
    "    this.worldEl.style.height=this.imgH+'px';",
    "    this.markersEl.style.width=this.imgW+'px';",
    "    this.markersEl.style.height=this.imgH+'px';",
    "    this.overlaysEl.style.width=this.imgW+'px';",
    "    this.overlaysEl.style.height=this.imgH+'px';",
    "    this.measureEl.style.width=this.imgW+'px';",
    "    this.measureEl.style.height=this.imgH+'px';",
    "    this.measureSvg.setAttribute('width', String(this.imgW));",
    "    this.measureSvg.setAttribute('height', String(this.imgH));",
    "  };",
    "",
    "  PublishMap.prototype.fitToView=function(){",
    "    var r=this.viewportEl.getBoundingClientRect();",
    "    this.vw=r.width||1; this.vh=r.height||1;",
    "    if(!this.imgW || !this.imgH) return;",
    "    var s=Math.min(this.vw/this.imgW, this.vh/this.imgH);",
    "    this.scale=clamp(s, this.cfg.minZoom, this.cfg.maxZoom);",
    "    this.tx=(this.vw - this.imgW*this.scale)/2;",
    "    this.ty=(this.vh - this.imgH*this.scale)/2;",
    "    this.applyTransform();",
    "  };",
    "",
    "  PublishMap.prototype.applyTransform=function(){",
    "    var scaledW=this.imgW*this.scale, scaledH=this.imgH*this.scale;",
    "    var minTx=this.vw - scaledW, maxTx=0;",
    "    var minTy=this.vh - scaledH, maxTy=0;",
    "    if(scaledW <= this.vw) this.tx=(this.vw-scaledW)/2; else this.tx=clamp(this.tx, minTx, maxTx);",
    "    if(scaledH <= this.vh) this.ty=(this.vh-scaledH)/2; else this.ty=clamp(this.ty, minTy, maxTy);",
    "    this.worldEl.style.transform='translate3d('+Math.round(this.tx)+'px,'+Math.round(this.ty)+'px,0) scale('+this.scale+')';",
    "    this.updateMarkerInvScale();",
    "    this.updateMarkerZoomVisibility();",
    "    this.renderCanvas();",
    "    this.renderMeasure();",
    "  };",
    "  PublishMap.prototype.onResize=function(){",
    "    if(!this.viewportEl) return;",
    "    if(this.cfg.viewportFrame){",
    "      this.applyViewportInset();",
    "    }",
    "    var r=this.viewportEl.getBoundingClientRect();",
    "    this.vw=r.width||1; this.vh=r.height||1;",
    "    if(this.responsiveEffective){",
    "      this.fitToView();",
    "    }else{",
    "      // keep current view but re-clamp to new bounds",
    "      this.applyTransform();",
    "    }",
    "    this.updateHudPinsForResize(r);",
    "    this.renderMarkers();",
    "    this.renderDrawings();",
    "    this.renderTextLayers();",
    "    this.renderCanvas();",
    "    this.renderMeasure();",
    "  };",
    "",
    "  PublishMap.prototype.panBy=function(dx,dy){ this.tx+=dx; this.ty+=dy; this.applyTransform(); };",
    "",
    "  PublishMap.prototype.onWheel=function(e){",
    "    var factor=1.1;",
    "    var step=Math.pow(factor, e.deltaY<0?1:-1);",
    "    this.zoomAt(e.clientX,e.clientY,step);",
    "  };",
    "",
    "  PublishMap.prototype.zoomAt=function(clientX,clientY,factor){",
    "    var r=this.viewportEl.getBoundingClientRect();",
    "    var cx=clamp(clientX-r.left,0,this.vw), cy=clamp(clientY-r.top,0,this.vh);",
    "    var sOld=this.scale, sNew=clamp(sOld*factor,this.cfg.minZoom,this.cfg.maxZoom);",
    "    var wx=(cx-this.tx)/sOld, wy=(cy-this.ty)/sOld;",
    "    this.scale=sNew;",
    "    this.tx=cx - wx*sNew;",
    "    this.ty=cy - wy*sNew;",
    "    this.applyTransform();",
    "  };",
    "",
    "  PublishMap.prototype.updateMarkerInvScale=function(){",
    "    var inv=1/this.scale;",
    "    var nodes=this.markersEl.querySelectorAll('.zm-marker-inv');",
    "    for(var i=0;i<nodes.length;i++) nodes[i].style.transform='scale('+inv+')';",
    "  };",
    "  PublishMap.prototype.updateMarkerZoomVisibility=function(){",
    "    var s=this.scale;",
    "    var nodes=this.host.querySelectorAll('.zm-marker');",
    "    for(var i=0;i<nodes.length;i++){",
    "      var el=nodes[i];",
    "      var minStr=el.dataset ? el.dataset.minz : null;",
    "      var maxStr=el.dataset ? el.dataset.maxz : null;",
    "      var hasMin=!!(minStr&&minStr.length);",
    "      var hasMax=!!(maxStr&&maxStr.length);",
    "      var min=hasMin?parseFloat(minStr):NaN;",
    "      var max=hasMax?parseFloat(maxStr):NaN;",
    "      var visible = (!hasMin || (isFinite(min) && s>=min)) && (!hasMax || (isFinite(max) && s<=max));",
    "      if(visible) el.classList.remove('zm-hidden'); else el.classList.add('zm-hidden');",
    "    }",
    "  };",

    "  PublishMap.prototype.classifyHudMetaFromCurrentPosition=function(m, vpRect){",
    "    var W = (vpRect && vpRect.width) ? vpRect.width : 1;",
    "    var H = (vpRect && vpRect.height) ? vpRect.height : 1;",
    "    var centerX = W/2, centerY = H/2;",
    "    var eps = 1;",
    "    var hudX = (typeof m.hudX==='number') ? m.hudX : 0;",
    "    var hudY = (typeof m.hudY==='number') ? m.hudY : 0;",
    "",
    "    var modeX;",
    "    if(Math.abs(hudX-centerX) <= eps){ modeX='center'; hudX=centerX; }",
    "    else if(hudX > centerX){ modeX='right'; }",
    "    else { modeX='left'; }",
    "",
    "    var modeY;",
    "    if(Math.abs(hudY-centerY) <= eps){ modeY='center'; hudY=centerY; }",
    "    else if(hudY > centerY){ modeY='bottom'; }",
    "    else { modeY='top'; }",
    "",
    "    m.anchorSpace='viewport';",
    "    m.hudX=hudX; m.hudY=hudY;",
    "    m.hudModeX=modeX; m.hudModeY=modeY;",
    "    m.hudLastWidth=W; m.hudLastHeight=H;",
    "    m.x = W>0 ? hudX/W : 0;",
    "    m.y = H>0 ? hudY/H : 0;",
    "  };",

    "  PublishMap.prototype.updateHudPinsForResize=function(vpRect){",
    "    if(!this.data || !Array.isArray(this.data.markers)) return;",
    "    var W = (vpRect && vpRect.width) ? vpRect.width : 1;",
    "    var H = (vpRect && vpRect.height) ? vpRect.height : 1;",
    "    var centerX=W/2, centerY=H/2;",
    "",
    "    for(var i=0;i<this.data.markers.length;i++){",
    "      var m=this.data.markers[i];",
    "      if(!m || m.anchorSpace!=='viewport') continue;",
    "",
    "      var hasLast = (typeof m.hudLastWidth==='number' && isFinite(m.hudLastWidth) && typeof m.hudLastHeight==='number' && isFinite(m.hudLastHeight));",
    "      if(!hasLast){",
    "        if(typeof m.hudX!=='number' || typeof m.hudY!=='number'){",
    "          var approxX = (typeof m.x==='number' ? m.x : 0.5) * W;",
    "          var approxY = (typeof m.y==='number' ? m.y : 0.5) * H;",
    "          m.hudX = approxX; m.hudY = approxY;",
    "        }",
    "        this.classifyHudMetaFromCurrentPosition(m, vpRect);",
    "        continue;",
    "      }",
    "",
    "      var lastW = m.hudLastWidth || W;",
    "      var lastH = m.hudLastHeight || H;",
    "      var dW = W - lastW;",
    "      var dH = H - lastH;",
    "",
    "      var hudX = (typeof m.hudX==='number') ? m.hudX : ((typeof m.x==='number'?m.x:0.5)*W);",
    "      var hudY = (typeof m.hudY==='number') ? m.hudY : ((typeof m.y==='number'?m.y:0.5)*H);",
    "",
    "      var modeX = m.hudModeX || 'center';",
    "      if(modeX==='right'){",
    "        hudX += dW;",
    "        if(hudX <= centerX){ hudX=centerX; m.hudModeX='center'; }",
    "      }else if(modeX==='center'){",
    "        hudX = centerX;",
    "      }",
    "",
    "      var modeY = m.hudModeY || 'center';",
    "      if(modeY==='bottom'){",
    "        hudY += dH;",
    "        if(hudY <= centerY){ hudY=centerY; m.hudModeY='center'; }",
    "      }else if(modeY==='center'){",
    "        hudY = centerY;",
    "      }",
    "",
    "      m.hudX=hudX; m.hudY=hudY;",
    "      m.hudLastWidth=W; m.hudLastHeight=H;",
    "      m.x = W>0 ? hudX/W : 0;",
    "      m.y = H>0 ? hudY/H : 0;",
    "    }",
    "  };",

    "  PublishMap.prototype.getIconProfile=function(iconKey){",
    "    var icons = (this.library && Array.isArray(this.library.icons)) ? this.library.icons : [];",
    "    var key = iconKey || (icons[0] ? icons[0].key : '');",
    "    for(var i=0;i<icons.length;i++){ if(icons[i] && icons[i].key===key) return icons[i]; }",
    "    if(icons[0]) return icons[0];",
    "    // builtin red pin fallback",
    "    return { key:'builtin', pathOrDataUrl:'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"#d23c3c\" d=\"M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7m0 9.5A2.5 2.5 0 1 1 12 6.5a2.5 2.5 0 0 1 0 5Z\"/></svg>'), size:24, anchorX:12, anchorY:12, rotationDeg:0 };",
    "  };",
    "  PublishMap.prototype.getPinSize=function(iconKey, fallback){",
    "    var ovs = (this.data && this.data.pinSizeOverrides && typeof this.data.pinSizeOverrides==='object') ? this.data.pinSizeOverrides : null;",
    "    if(ovs && iconKey && Object.prototype.hasOwnProperty.call(ovs, iconKey)){",
    "      var v = ovs[iconKey];",
    "      if(typeof v==='number' && isFinite(v) && v>0) return v;",
    "    }",
    "    return fallback;",
    "  };",
    "  PublishMap.prototype.getIconDefaultLink=function(iconKey){",
    "    var prof = this.getIconProfile(iconKey);",
    "    var raw = prof && prof.defaultLink;",
    "    var s = (typeof raw==='string') ? raw.trim() : '';",
    "    return s ? s : '';",
    "  };",

    "  PublishMap.prototype.findSwapPresetById=function(id){",
    "    var cols = (this.library && Array.isArray(this.library.baseCollections)) ? this.library.baseCollections : [];",
    "    for(var i=0;i<cols.length;i++){",
    "      var inc = cols[i] && cols[i].include;",
    "      var list = inc && Array.isArray(inc.swapPins) ? inc.swapPins : [];",
    "      for(var j=0;j<list.length;j++){",
    "        var sp = list[j];",
    "        if(sp && sp.id === id) return sp;",
    "      }",
    "    }",
    "    return null;",
    "  };",

    "  PublishMap.prototype.getSwapFrameForMarker=function(m){",
    "    if(!m || m.type !== 'swap' || !m.swapKey) return null;",
    "    var preset = this.findSwapPresetById(m.swapKey);",
    "    if(!preset || !Array.isArray(preset.frames) || preset.frames.length===0) return null;",
    "    var raw = (typeof m.swapIndex==='number') ? m.swapIndex : 0;",
    "    var n = preset.frames.length;",
    "    var idx = ((raw % n) + n) % n;",
    "    return preset.frames[idx] || null;",
    "  };",

    "  PublishMap.prototype.getSwapEffectiveLink=function(m){",
    "    if(!m || m.type !== 'swap' || !m.swapKey) return (m && m.link) ? String(m.link).trim() : '';",
    "    var preset = this.findSwapPresetById(m.swapKey);",
    "    if(!preset || !Array.isArray(preset.frames) || preset.frames.length===0) return (m.link||'').trim();",
    "    var raw = (typeof m.swapIndex==='number') ? m.swapIndex : 0;",
    "    var n = preset.frames.length;",
    "    var idx = ((raw % n) + n) % n;",
    "    // per-marker overrides",
    "    if(m.swapLinks && typeof m.swapLinks==='object'){",
    "      var ov = m.swapLinks[idx];",
    "      if(typeof ov==='string' && ov.trim()) return ov.trim();",
    "    }",
    "    // preset frame link",
    "    var fr = preset.frames[idx];",
    "    if(fr && typeof fr.link==='string' && fr.link.trim()) return fr.link.trim();",
    "    // icon default link",
    "    if(fr && fr.iconKey){",
    "      var dl = this.getIconDefaultLink(fr.iconKey);",
    "      if(dl) return dl;",
    "    }",
    "    return (m.link||'').trim();",
    "  };",

    "  PublishMap.prototype.advanceSwapPin=function(m){",
    "    if(!m || m.type !== 'swap' || !m.swapKey) return;",
    "    var preset = this.findSwapPresetById(m.swapKey);",
    "    if(!preset || !Array.isArray(preset.frames) || preset.frames.length===0) return;",
    "    var raw = (typeof m.swapIndex==='number') ? m.swapIndex : 0;",
    "    var n = preset.frames.length;",
    "    m.swapIndex = ((raw + 1) % n + n) % n;",
    "  };",
    "  PublishMap.prototype.renderMarkers=function(){",
    "    var self=this;",
    "    if(!self.data) return;",
    "    var layers = Array.isArray(self.data.layers) ? self.data.layers : [];",
    "    var markers = Array.isArray(self.data.markers) ? self.data.markers : [];",
    "",
    "    var visible = new Set();",
    "    for(var i=0;i<layers.length;i++){",
    "      var l=layers[i];",
    "      if(l && l.visible!==false && !isHiddenLayerName(l.name||'')) visible.add(l.id);",
    "    }",
    "",
    "    self.markersEl.innerHTML='';",
    "    if(self.hudMarkersEl) self.hudMarkersEl.innerHTML='';",
    "",
    "    var vpRect = self.viewportEl.getBoundingClientRect();",
    "    var vw = vpRect.width || 1;",
    "    var vh = vpRect.height || 1;",
    "    self.updateHudPinsForResize(vpRect);",
    "",
    "    for(var j=0;j<markers.length;j++){",
    "      var m=markers[j];",
    "      if(!m || !visible.has(m.layer)) continue;",
    "",
    "      var isHud = (m.anchorSpace === 'viewport');",
    "      var container = isHud ? self.hudMarkersEl : self.markersEl;",
    "      if(!container) continue;",
    "",
    "      var left, top;",
    "      if(isHud){",
    "        left = (typeof m.hudX==='number') ? m.hudX : ((typeof m.x==='number'?m.x:0.5) * vw);",
    "        top  = (typeof m.hudY==='number') ? m.hudY : ((typeof m.y==='number'?m.y:0.5) * vh);",
    "      }else{",
    "        left = (typeof m.x==='number'?m.x:0) * self.imgW;",
    "        top  = (typeof m.y==='number'?m.y:0) * self.imgH;",
    "      }",
    "",
    "      var host = document.createElement('div');",
    "      host.className = isHud ? 'zm-marker zm-hud-marker' : 'zm-marker';",
    "      host.style.left = left + 'px';",
    "      host.style.top  = top  + 'px';",
    "      host.dataset && (host.dataset.id = m.id || '');",
    "      host.addEventListener('pointerdown', function(ev){ ev.stopPropagation(); });",

    "      // Determine effective link (swap pins can override per-frame)",
    "      var link = '';",
    "      if(m.type === 'swap'){ link = self.getSwapEffectiveLink(m); }",
    "      else link = (m.link||'').trim();",

    "      // Page preview on Publish: use a real <a class=\"internal-link\">",
    "      var clickTarget = host;",
    "      if(link){",
    "        var a = document.createElement('a');",
    "        a.className = 'internal-link';",
    "        a.setAttribute('data-href', stripWikiBrackets(link));",
    "        a.href = resolveNoteHref(link);",
    "        a.style.display = 'block';",
    "        a.style.textDecoration = 'none';",
    "        a.style.color = 'inherit';",
    "        clickTarget = a;",
    "        host.appendChild(a);",
    "      }",	
    "",
    "      // Zoom visibility (world pins only)",
    "      if(!isHud && m.type !== 'sticker'){",
    "        if(typeof m.minZoom==='number') host.dataset.minz = String(m.minZoom);",
    "        if(typeof m.maxZoom==='number') host.dataset.maxz = String(m.maxZoom);",
    "      }",
    "",
    "      var tooltip = (m.tooltip||'').trim();",
    "      if(tooltip){",
    "        host.title = tooltip;",
    "      }",
    "",
    "      // render icon",
    "      if(m.type === 'sticker'){",
    "        var size = Math.max(1, Math.round(m.stickerSize || 64));",
    "        var anch = document.createElement('div');",
    "        anch.className='zm-marker-anchor';",
    "        anch.style.transform='translate(' + (-size/2) + 'px,' + (-size/2) + 'px)';",
    "        var img = document.createElement('img');",
    "        img.className='zm-marker-icon';",
    "        img.src = resolveAssetUrl(m.stickerPath || '', false);",
    "        img.style.width = size + 'px';",
    "        anch.appendChild(img);",
    "        clickTarget.appendChild(anch);",
    "      }else{",
    "        var effectiveKey = m.iconKey;",
    "        if(m.type === 'swap'){",
    "          var fr = self.getSwapFrameForMarker(m);",
    "          if(fr && fr.iconKey) effectiveKey = fr.iconKey;",
    "        }",
    "        var prof = self.getIconProfile(effectiveKey);",
    "        var imgUrl = resolveAssetUrl(prof.pathOrDataUrl || '', false);",
    "        var pinSize = self.getPinSize(effectiveKey, (prof.size||24));",
    "        var anch2;",
    "        if(isHud || m.scaleLikeSticker){",
    "          anch2 = document.createElement('div');",
    "          anch2.className='zm-marker-anchor';",
    "          anch2.style.transform='translate(' + (- (prof.anchorX||0)) + 'px,' + (- (prof.anchorY||0)) + 'px)';",
    "          var img2 = document.createElement('img');",
    "          img2.className='zm-marker-icon';",
    "          img2.src = imgUrl;",
    "          img2.style.width = pinSize + 'px';",
    "          if(prof.rotationDeg) img2.style.transform='rotate(' + prof.rotationDeg + 'deg)';",
    "          anch2.appendChild(img2);",
    "          clickTarget.appendChild(anch2);",
    "        }else{",
    "          var inv = document.createElement('div');",
    "          inv.className='zm-marker-inv';",
    "          inv.style.transform='scale(' + (1/self.scale) + ')';",
    "          anch2 = document.createElement('div');",
    "          anch2.className='zm-marker-anchor';",
    "          anch2.style.transform='translate(' + (- (prof.anchorX||0)) + 'px,' + (- (prof.anchorY||0)) + 'px)';",
    "          var img3 = document.createElement('img');",
    "          img3.className='zm-marker-icon';",
    "          img3.src = imgUrl;",
    "          img3.style.width = pinSize + 'px';",
    "          if(prof.rotationDeg) img3.style.transform='rotate(' + prof.rotationDeg + 'deg)';",
    "          anch2.appendChild(img3);",
    "          inv.appendChild(anch2);",
    "          clickTarget.appendChild(inv);",
    "        }",
    "      }",
    "      if(m.type === 'swap'){",
    "        (function(marker){",
    "          host.addEventListener('contextmenu', function(ev){",
    "            ev.preventDefault();",
    "            ev.stopPropagation();",
    "            self.advanceSwapPin(marker);",
    "            self.renderMarkers();",
    "          });",
    "        })(m);",
    "      }",
    "",
    "      container.appendChild(host);",
    "    }",
    "",
    "    self.updateMarkerZoomVisibility();",
    "  };",
    "",
    "  PublishMap.prototype.renderOverlays=function(){",
    "    // v0.2: if markers data includes overlays, use them; else none.",
    "    var arr = this.getOverlaysNormalized();",
    "    this.overlaysEl.innerHTML='';",
    "    for(var i=0;i<arr.length;i++){",
    "      var o=arr[i];",
    "      if(!o || o.visible===false) continue;",
    "      var img=document.createElement('img');",
    "      img.className='zm-overlay-image';",
    "      img.src=resolveAssetUrl(o.path||'', false);",
    "      this.overlaysEl.appendChild(img);",
    "    }",
    "  };",

  "  PublishMap.prototype.renderDrawings=function(){",
  "    var self=this;",
  "    if(!self.drawSvg || !self.drawLayer || !self.drawDefs) return;",
  "    self.drawSvg.setAttribute('width', String(self.imgW));",
  "    self.drawSvg.setAttribute('height', String(self.imgH));",
  "    self.drawLayer.innerHTML='';",
  "    self.drawDefs.innerHTML='';",
  "    var drawings = (self.data && Array.isArray(self.data.drawings)) ? self.data.drawings : [];",
  "    if(!drawings.length) return;",
  "    var visibleDrawLayers = {};",
  "    var drawLayers = (self.data && Array.isArray(self.data.drawLayers)) ? self.data.drawLayers : [];",
  "    for(var i=0;i<drawLayers.length;i++){",
  "      var dl=drawLayers[i];",
  "      if(dl && dl.visible===true) visibleDrawLayers[dl.id]=true;",
  "    }",
  "    function toAbs(nx,ny){ return { x: nx*self.imgW, y: ny*self.imgH }; }",
  "    function clamp01(n){ return Math.min(1, Math.max(0, n)); }",
  "    function addArrowMarker(id,color){",
  "      var ns='http://www.w3.org/2000/svg';",
  "      var m=document.createElementNS(ns,'marker');",
  "      m.setAttribute('id', id);",
  "      m.setAttribute('viewBox','0 0 10 10');",
  "      m.setAttribute('refX','10');",
  "      m.setAttribute('refY','5');",
  "      m.setAttribute('markerWidth','6');",
  "      m.setAttribute('markerHeight','6');",
  "      m.setAttribute('orient','auto');",
  "      m.setAttribute('markerUnits','strokeWidth');",
  "      var p=document.createElementNS(ns,'path');",
  "      p.setAttribute('d','M 0 0 L 10 5 L 0 10 z');",
  "      p.setAttribute('fill', color);",
  "      m.appendChild(p);",
  "      self.drawDefs.appendChild(m);",
  "      return 'url(#'+id+')';",
  "    }",
  "    function setStroke(el, style){",
  "      var stroke=(style.strokeColor||'#ff0000').trim() || '#ff0000';",
  "      var w = (typeof style.strokeWidth==='number' && isFinite(style.strokeWidth) && style.strokeWidth>0) ? style.strokeWidth : 2;",
  "      el.setAttribute('stroke', stroke);",
  "      el.setAttribute('stroke-width', String(w));",
  "      el.setAttribute('fill','none');",
  "      if(Array.isArray(style.strokeDash) && style.strokeDash.length){ el.setAttribute('stroke-dasharray', style.strokeDash.join(' ')); }",
  "      var op = (typeof style.strokeOpacity==='number' && isFinite(style.strokeOpacity)) ? clamp01(style.strokeOpacity) : 1;",
  "      if(op < 1) el.setAttribute('stroke-opacity', String(op));",
  "      return stroke;",
  "    }",
  "    function bboxFromAbsPoints(pts){",
  "      var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;",
  "      for(var k=0;k<pts.length;k++){",
  "        var p=pts[k];",
  "        if(!p) continue;",
  "        minX=Math.min(minX,p.x); maxX=Math.max(maxX,p.x);",
  "        minY=Math.min(minY,p.y); maxY=Math.max(maxY,p.y);",
  "      }",
  "      if(!isFinite(minX)) return null;",
  "      return { minX:minX, minY:minY, w:(maxX-minX), h:(maxY-minY) };",
  "    }",
  "    function maybeFillShape(shape, d){",
  "      var style=d.style||{};",
  "      if(d.kind==='polyline') return;",
  "      var pattern = style.fillPattern || (style.fillColor ? 'solid' : 'none');",
  "      if(pattern==='none') return;",
  "      // baked patterns: render baked svg image if present",
  "      if((pattern==='striped' || pattern==='cross' || pattern==='wavy') && d.bakedPath){",
  "        var box = null;",
  "        if(d.kind==='rect' && d.rect){",
  "          var a=toAbs(d.rect.x0,d.rect.y0), b=toAbs(d.rect.x1,d.rect.y1);",
  "          box={ minX:Math.min(a.x,b.x), minY:Math.min(a.y,b.y), w:Math.abs(a.x-b.x), h:Math.abs(a.y-b.y) };",
  "        } else if(d.kind==='circle' && d.circle){",
  "          var c=toAbs(d.circle.cx,d.circle.cy);",
  "          var r=d.circle.r*Math.max(self.imgW,self.imgH);",
  "          box={ minX:c.x-r, minY:c.y-r, w:r*2, h:r*2 };",
  "        } else if(d.kind==='polygon' && Array.isArray(d.polygon) && d.polygon.length>=2){",
  "          var abs=[]; for(var i=0;i<d.polygon.length;i++){ abs.push(toAbs(d.polygon[i].x,d.polygon[i].y)); }",
  "          box=bboxFromAbsPoints(abs);",
  "        }",
  "        if(box && box.w>0 && box.h>0){",
  "          var ns='http://www.w3.org/2000/svg';",
  "          var img=document.createElementNS(ns,'image');",
  "          img.setAttribute('href', resolveAssetUrl(d.bakedPath, false));",
  "          img.setAttribute('x', String(box.minX));",
  "          img.setAttribute('y', String(box.minY));",
  "          img.setAttribute('width', String(box.w));",
  "          img.setAttribute('height', String(box.h));",
  "          img.classList.add('zm-draw__shape');",
  "          self.drawLayer.appendChild(img);",
  "          return;",
  "        }",
  "      }",
  "      // solid fallback fill",
  "      var fc=(style.fillColor||'#ff0000').trim() || '#ff0000';",
  "      var fo=(typeof style.fillOpacity==='number' && isFinite(style.fillOpacity)) ? clamp01(style.fillOpacity) : 0.15;",
  "      var fill=shape.cloneNode(false);",
  "      fill.classList.add('zm-draw__shape');",
  "      fill.setAttribute('fill', fc);",
  "      fill.setAttribute('fill-opacity', String(fo));",
  "      fill.setAttribute('stroke','none');",
  "      self.drawLayer.appendChild(fill);",
  "    }",
  "    function polylineMidAndAngle(absPts){",
  "      var total=0;",
  "      for(var i=1;i<absPts.length;i++){",
  "        total += Math.hypot(absPts[i].x-absPts[i-1].x, absPts[i].y-absPts[i-1].y);",
  "      }",
  "      if(total<=0) return null;",
  "      var target=total/2, acc=0;",
  "      for(var j=1;j<absPts.length;j++){",
  "        var p0=absPts[j-1], p1=absPts[j];",
  "        var seg=Math.hypot(p1.x-p0.x, p1.y-p0.y);",
  "        if(acc+seg>=target && seg>0){",
  "          var t=(target-acc)/seg;",
  "          var x=p0.x+(p1.x-p0.x)*t;",
  "          var y=p0.y+(p1.y-p0.y)*t;",
  "          var ang=Math.atan2(p1.y-p0.y, p1.x-p0.x)*180/Math.PI;",
  "          return { x:x, y:y, angleDeg:ang, pxLen: total };",
  "        }",
  "        acc += seg;",
  "      }",
  "      return null;",
  "    }",
  "    for(var n=0;n<drawings.length;n++){",
  "      var d=drawings[n];",
  "      if(!d || d.visible===false) continue;",
  "      if(drawLayers.length && !visibleDrawLayers[d.layerId]) continue;",
  "      var ns='http://www.w3.org/2000/svg';",
  "      var style=d.style||{};",
  "      var shape=null;",
  "      if(d.kind==='circle' && d.circle){",
  "        var c=toAbs(d.circle.cx,d.circle.cy);",
  "        var r=d.circle.r*Math.max(self.imgW,self.imgH);",
  "        var el=document.createElementNS(ns,'circle');",
  "        el.setAttribute('cx', String(c.x));",
  "        el.setAttribute('cy', String(c.y));",
  "        el.setAttribute('r', String(r));",
  "        shape=el;",
  "      } else if(d.kind==='rect' && d.rect){",
  "        var a=toAbs(d.rect.x0,d.rect.y0), b=toAbs(d.rect.x1,d.rect.y1);",
  "        var x=Math.min(a.x,b.x), y=Math.min(a.y,b.y), w=Math.abs(a.x-b.x), h=Math.abs(a.y-b.y);",
  "        var el2=document.createElementNS(ns,'rect');",
  "        el2.setAttribute('x', String(x));",
  "        el2.setAttribute('y', String(y));",
  "        el2.setAttribute('width', String(w));",
  "        el2.setAttribute('height', String(h));",
  "        shape=el2;",
  "      } else if(d.kind==='polygon' && Array.isArray(d.polygon) && d.polygon.length>=2){",
  "        var pth=document.createElementNS(ns,'path');",
  "        var dd='';",
  "        for(var i2=0;i2<d.polygon.length;i2++){",
  "          var p=toAbs(d.polygon[i2].x, d.polygon[i2].y);",
  "          dd += (i2===0?'M ':' L ') + p.x + ' ' + p.y;",
  "        }",
  "        dd += ' Z';",
  "        pth.setAttribute('d', dd);",
  "        shape=pth;",
  "      } else if(d.kind==='polyline' && Array.isArray(d.polyline) && d.polyline.length>=2){",
  "        var pth2=document.createElementNS(ns,'path');",
  "        var dd2='';",
  "        var absPts=[];",
  "        for(var i3=0;i3<d.polyline.length;i3++){",
  "          var pp=toAbs(d.polyline[i3].x, d.polyline[i3].y);",
  "          absPts.push(pp);",
  "          dd2 += (i3===0?'M ':' L ') + pp.x + ' ' + pp.y;",
  "        }",
  "        pth2.setAttribute('d', dd2);",
  "        pth2.setAttribute('stroke-linecap','round');",
  "        pth2.setAttribute('stroke-linejoin','round');",
  "        shape=pth2;",
  "        // distance label",
  "        if(style.distanceLabel){",
  "          var mid=polylineMidAndAngle(absPts);",
  "          if(mid){",
  "            var txt=self.formatPolylineDistance(mid.pxLen);",
  "            if(txt){",
  "              var tEl=document.createElementNS(ns,'text');",
  "              tEl.classList.add('zm-draw__label');",
  "              tEl.setAttribute('x', String(mid.x));",
  "              tEl.setAttribute('y', String(mid.y));",
  "              tEl.setAttribute('text-anchor','middle');",
  "              tEl.setAttribute('dominant-baseline','middle');",
  "              tEl.setAttribute('fill', (style.strokeColor||'#ff0000'));",
  "              if(Math.abs(mid.angleDeg)>0.01){ tEl.setAttribute('transform','rotate('+mid.angleDeg+' '+mid.x+' '+mid.y+')'); }",
  "              tEl.textContent=txt;",
  "              self.drawLayer.appendChild(tEl);",
  "            }",
  "          }",
  "        }",
  "      }",
  "      if(!shape) continue;",
  "      // fill below stroke",
  "      maybeFillShape(shape, d);",
  "      // stroke on top",
  "      shape.classList.add('zm-draw__shape');",
  "      var strokeColor=setStroke(shape, style);",
  "      if(d.kind==='polyline' && style.arrowEnd){",
  "        var mid='zm-arrow-'+String(d.id||n);",
  "        var url=addArrowMarker(mid, strokeColor);",
  "        shape.setAttribute('marker-end', url);",
  "      }",
  "      self.drawLayer.appendChild(shape);",
  "    }",
  "  };",

  "  PublishMap.prototype.ensureTextStyle=function(st){",
  "    var s=st||{};",
  "    return {",
  "      fontFamily: (s.fontFamily||'var(--font-text)').trim() || 'var(--font-text)',",
  "      fontSize: (typeof s.fontSize==='number' && isFinite(s.fontSize) && s.fontSize>1) ? s.fontSize : 14,",
  "      color: (s.color||'var(--text-normal)').trim() || 'var(--text-normal)',",
  "      fontWeight: (s.fontWeight!=null ? String(s.fontWeight).trim() : ''),",
  "      italic: (s.italic===true),",
  "      letterSpacing: (typeof s.letterSpacing==='number' && isFinite(s.letterSpacing)) ? s.letterSpacing : null,",
  "      padLeft: (typeof s.padLeft==='number' && isFinite(s.padLeft) && s.padLeft>=0) ? s.padLeft : 0,",
  "      padRight: (typeof s.padRight==='number' && isFinite(s.padRight) && s.padRight>=0) ? s.padRight : 0",
  "    };",
  "  };",

  "  PublishMap.prototype.renderTextLayers=function(){",
  "    var self=this;",
  "    if(!self.textSvg || !self.textLayer) return;",
  "    self.textSvg.setAttribute('width', String(self.imgW));",
  "    self.textSvg.setAttribute('height', String(self.imgH));",
  "    self.textLayer.innerHTML='';",
  "    var layers = (self.data && Array.isArray(self.data.textLayers)) ? self.data.textLayers : [];",
  "    if(!layers.length) return;",
  "    var ns='http://www.w3.org/2000/svg';",
  "    function toAbs(nx,ny){ return { x:nx*self.imgW, y:ny*self.imgH }; }",
  "    for(var i=0;i<layers.length;i++){",
  "      var layer=layers[i];",
  "      if(!layer || !Array.isArray(layer.lines)) continue;",
  "      var st=self.ensureTextStyle(layer.style);",
  "      for(var j=0;j<layer.lines.length;j++){",
  "        var ln=layer.lines[j];",
  "        var txt=(ln && ln.text) ? String(ln.text).trimEnd() : '';",
  "        if(!txt) continue;",
  "        var a=toAbs(ln.x0, ln.y0);",
  "        var b=toAbs(ln.x1, ln.y1);",
  "        var dx=b.x-a.x, dy=b.y-a.y;",
  "        var angle=Math.atan2(dy,dx)*180/Math.PI;",
  "        var x=a.x + (st.padLeft||0);",
  "        var y=a.y;",
  "        var t=document.createElementNS(ns,'text');",
  "        t.setAttribute('x', String(x));",
  "        t.setAttribute('y', String(y));",
  "        t.textContent=txt;",
  "        t.style.fill=st.color;",
  "        t.style.fontFamily=st.fontFamily;",
  "        t.style.fontSize=String(st.fontSize)+'px';",
  "        if(st.fontWeight) t.style.fontWeight=st.fontWeight;",
  "        if(st.italic) t.style.fontStyle='italic';",
  "        if(st.letterSpacing!=null) t.style.letterSpacing=String(st.letterSpacing)+'px';",
  "        if(Math.abs(angle)>0.01){ t.setAttribute('transform','rotate('+angle+' '+x+' '+y+')'); }",
  "        self.textLayer.appendChild(t);",
  "      }",
  "    }",
  "  };",
    "",
    "  PublishMap.prototype.renderCanvas=function(){",
    "    if(this.cfg.renderMode!=='canvas') return;",
    "    if(!this.baseCanvas || !this.baseCtx || !this.baseImg) return;",
    "    var r=this.viewportEl.getBoundingClientRect();",
    "    this.vw=r.width||1; this.vh=r.height||1;",
    "    var dpr=Math.max(1, window.devicePixelRatio||1);",
    "    var w=Math.max(1, Math.round(this.vw*dpr));",
    "    var h=Math.max(1, Math.round(this.vh*dpr));",
    "    if(this.baseCanvas.width!==w || this.baseCanvas.height!==h){",
    "      this.baseCanvas.width=w; this.baseCanvas.height=h;",
    "      this.baseCanvas.style.width=this.vw+'px';",
    "      this.baseCanvas.style.height=this.vh+'px';",
    "    }",
    "    var ctx=this.baseCtx;",
    "    ctx.setTransform(dpr,0,0,dpr,0,0);",
    "    ctx.clearRect(0,0,this.vw,this.vh);",
    "    ctx.translate(this.tx,this.ty);",
    "    ctx.scale(this.scale,this.scale);",
    "    ctx.imageSmoothingEnabled=true;",
    "    ctx.drawImage(this.baseImg,0,0);",
    "    // Hide DOM base/overlays in canvas mode",
    "    this.imgEl.style.display='none';",
    "    this.overlaysEl.style.display='none';",
    "  };",
    "",
    "  // ===== Measure tool (read-only, uses stored calibration if present) =====",
    "  PublishMap.prototype.toggleMeasure=function(){",
    "    this.measuring=!this.measuring;",
    "    if(!this.measuring) this.measurePreview=null;",
    "    this.updateMeasureHud();",
    "    this.renderMeasure();",
    "  };",
    "  PublishMap.prototype.clientToWorldNorm=function(clientX,clientY){",
    "    var r=this.viewportEl.getBoundingClientRect();",
    "    var vx=clientX-r.left, vy=clientY-r.top;",
    "    var wx=(vx-this.tx)/this.scale, wy=(vy-this.ty)/this.scale;",
    "    return { x: clamp(wx/this.imgW,0,1), y: clamp(wy/this.imgH,0,1) };",
    "  };",
    "  PublishMap.prototype.addMeasurePointFromEvent=function(e){",
    "    this.measurePts.push(this.clientToWorldNorm(e.clientX,e.clientY));",
    "    this.renderMeasure();",
    "  };",
    "  PublishMap.prototype.updateMeasurePreviewFromEvent=function(e){",
    "    this.measurePreview=this.clientToWorldNorm(e.clientX,e.clientY);",
    "    this.renderMeasure();",
    "  };",
    "  PublishMap.prototype.clearMeasure=function(){ this.measurePts=[]; this.measurePreview=null; this.renderMeasure(); };",
    "  PublishMap.prototype.removeLastMeasurePoint=function(){ if(this.measurePts.length) this.measurePts.pop(); this.renderMeasure(); };",
    "  PublishMap.prototype.getMetersPerPixel=function(){",
    "    var m=this.data && this.data.measurement ? this.data.measurement : null;",
    "    if(!m) return null;",
    "    var base=this.getActiveBasePath();",
    "    if(m.scales && isNum(m.scales[base])) return m.scales[base];",
    "    if(isNum(m.metersPerPixel)) return m.metersPerPixel;",
    "    return null;",
    "  };",

    "  PublishMap.prototype.getEnabledTravelPack=function(){",
    "    var packs = (this.library && Array.isArray(this.library.travelRulesPacks)) ? this.library.travelRulesPacks : [];",
    "    for(var i=0;i<packs.length;i++){ if(packs[i] && packs[i].enabled===true) return packs[i]; }",
    "    return packs[0] || null;",
    "  };",

    "  PublishMap.prototype.getActiveCustomUnits=function(){",
    "    var p=this.getEnabledTravelPack();",
    "    return (p && Array.isArray(p.customUnits)) ? p.customUnits : [];",
    "  };",

    "  PublishMap.prototype.getActiveTravelTimePresets=function(){",
    "    var p=this.getEnabledTravelPack();",
    "    return (p && Array.isArray(p.travelTimePresets)) ? p.travelTimePresets : [];",
    "  };",

    "  PublishMap.prototype.getActiveTravelPerDayPresets=function(){",
    "    var p=this.getEnabledTravelPack();",
    "    // prefer new field travelPerDayPresets; fallback to legacy travelPerDay",
    "    if(p && Array.isArray(p.travelPerDayPresets) && p.travelPerDayPresets.length) return p.travelPerDayPresets;",
    "    if(p && p.travelPerDay && isNum(p.travelPerDay.value) && typeof p.travelPerDay.unit==='string'){",
    "      return [{ id:'legacy', name:'Default', value:p.travelPerDay.value, unit:p.travelPerDay.unit }];",
    "    }",
    "    return [];",
    "  };",

    "  PublishMap.prototype.getCustomPxPerUnit=function(customUnitId){",
    "    var meas = (this.data && this.data.measurement) ? this.data.measurement : null;",
    "    if(!meas || !meas.customUnitPxPerUnit) return null;",
    "    var base=this.getActiveBasePath();",
    "    var perBase = meas.customUnitPxPerUnit[base];",
    "    if(perBase && isNum(perBase[customUnitId]) && perBase[customUnitId]>0) return perBase[customUnitId];",
    "    return null;",
    "  };",

    "  PublishMap.prototype.getEffectivePxPerCustomUnit=function(customUnitId){",
    "    var direct=this.getCustomPxPerUnit(customUnitId);",
    "    if(direct) return direct;",
    "    // fallback: if we have mpp + metersPerUnit, derive px/unit = metersPerUnit / mpp",
    "    var mpp=this.getMetersPerPixel();",
    "    if(!mpp) return null;",
    "    var defs=this.getActiveCustomUnits();",
    "    for(var i=0;i<defs.length;i++){",
    "      var d=defs[i];",
    "      if(d && d.id===customUnitId && isNum(d.metersPerUnit) && d.metersPerUnit>0){",
    "        return d.metersPerUnit / mpp;",
    "      }",
    "    }",
    "    return null;",
    "  };",

    "  PublishMap.prototype.formatCustomDistanceFromPixels=function(px){",
    "    var meas = (this.data && this.data.measurement) ? this.data.measurement : null;",
    "    var defs=this.getActiveCustomUnits();",
    "    if(!meas || !defs.length) return Math.round(px)+' px';",
    "    var id = meas.customUnitId || defs[0].id;",
    "    var def=null;",
    "    for(var i=0;i<defs.length;i++){ if(defs[i] && defs[i].id===id){ def=defs[i]; break; } }",
    "    def = def || defs[0];",
    "    var pxPerUnit=this.getEffectivePxPerCustomUnit(def.id);",
    "    var label=(def.abbreviation||def.name||'u').trim() || 'u';",
    "    if(!pxPerUnit) return 'No calibration ('+label+')';",
    "    var val=px/pxPerUnit;",
    "    var rounded=Math.round(val*100)/100;",
    "    return rounded+' '+label;",
    "  };",

    "  PublishMap.prototype.formatDistance=function(meters){",
    "    var meas=this.data && this.data.measurement ? this.data.measurement : null;",
    "    var unit=meas && meas.displayUnit ? String(meas.displayUnit) : 'km';",
    "    function round(v,d){ var p=Math.pow(10,d); return Math.round(v*p)/p; }",
    "    if(unit==='custom'){",
    "      // For travel: custom display is driven by px calibration, not meters. Keep a sane fallback.",
    "      return round(meters/1000,3)+' km';",
    "    }",
    "    if(unit==='m') return Math.round(meters)+' m';",
    "    if(unit==='mi') return round(meters/1609.344,3)+' mi';",
    "    if(unit==='ft') return Math.round(meters/0.3048)+' ft';",
    "    return round(meters/1000,3)+' km';",
    "  };",

    "  PublishMap.prototype.formatPolylineDistance=function(px){",
    "    var meas=this.data && this.data.measurement ? this.data.measurement : null;",
    "    var unit=meas && meas.displayUnit ? String(meas.displayUnit) : 'km';",
    "    if(unit==='custom') return this.formatCustomDistanceFromPixels(px);",
    "    var mpp=this.getMetersPerPixel();",
    "    if(!mpp) return null;",
    "    return this.formatDistance(px*mpp);",
    "  };",

    "  PublishMap.prototype.computeTravelTimeLines=function(distanceMeters){",
    "    var meas=this.data && this.data.measurement ? this.data.measurement : null;",
    "    if(!meas) return [];",
    "    var selected = Array.isArray(meas.travelTimePresetIds) ? meas.travelTimePresetIds : [];",
    "    if(!selected.length) return [];",
    "    var presets=this.getActiveTravelTimePresets();",
    "    var out=[];",
    "    // per-day",
    "    var perDayPresets=this.getActiveTravelPerDayPresets();",
    "    var perDaySelId = (typeof meas.travelDayPresetId==='string') ? meas.travelDayPresetId.trim() : '';",
    "    var perDay = null;",
    "    if(perDaySelId){ for(var i=0;i<perDayPresets.length;i++){ if(perDayPresets[i].id===perDaySelId){ perDay=perDayPresets[i]; break; } } }",
    "    perDay = perDay || perDayPresets[0] || null;",
    "    var showDays = meas.travelDaysEnabled===true;",
    "",
    "    function travelDistanceToMeters(value, unit, customId, self){",
    "      if(!isNum(value) || value<=0) return null;",
    "      if(unit==='km') return value*1000;",
    "      if(unit==='mi') return value*1609.344;",
    "      if(unit==='ft') return value*0.3048;",
    "      if(unit==='m') return value;",
    "      if(unit==='custom'){",
    "        if(!customId) return null;",
    "        var pxPerUnit=self.getEffectivePxPerCustomUnit(customId);",
    "        var mpp=self.getMetersPerPixel();",
    "        if(!pxPerUnit || !mpp) return null;",
    "        return value*(pxPerUnit*mpp);",
    "      }",
    "      return null;",
    "    }",
    "    function fmtNum(v){",
    "      var a=Math.abs(v);",
    "      var d=(a<10)?2:(a<100)?1:0;",
    "      var p=Math.pow(10,d);",
    "      return String(Math.round(v*p)/p);",
    "    }",
    "",
    "    for(var p=0;p<presets.length;p++){",
    "      var pr=presets[p];",
    "      if(!pr || !pr.id) continue;",
    "      if(selected.indexOf(pr.id)<0) continue;",
    "      var ref=travelDistanceToMeters(pr.distanceValue, pr.distanceUnit, pr.distanceCustomUnitId, this);",
    "      if(!ref || !isNum(pr.timeValue) || pr.timeValue<=0 || !pr.timeUnit) continue;",
    "      var t=(distanceMeters/ref)*pr.timeValue;",
    "      out.push('Time ('+(pr.name||pr.id)+'): '+fmtNum(t)+' '+pr.timeUnit);",
    "",
    "      if(!showDays) continue;",
    "      if(!perDay || !isNum(perDay.value) || perDay.value<=0 || !perDay.unit){",
    "        out.push('Travel days: not configured');",
    "        continue;",
    "      }",
    "      var u1=String(pr.timeUnit||'').trim().toLowerCase();",
    "      var u2=String(perDay.unit||'').trim().toLowerCase();",
    "      if(u1!==u2){",
    "        out.push('Travel days: unit mismatch (preset: '+pr.timeUnit+', max: '+perDay.unit+')');",
    "        continue;",
    "      }",
    "      var full=Math.floor(t/perDay.value);",
    "      var rest=t-full*perDay.value;",
    "      var label=perDay.name ? ' ('+perDay.name+')' : '';",
    "      if(Math.abs(rest) < 1e-6) out.push('Travel days'+label+' ('+perDay.value+' '+perDay.unit+'/day): '+full+'d');",
    "      else if(full<=0) out.push('Travel days'+label+' ('+perDay.value+' '+perDay.unit+'/day): 0d + '+fmtNum(rest)+' '+pr.timeUnit);",
    "      else out.push('Travel days'+label+' ('+perDay.value+' '+perDay.unit+'/day): '+full+'d + '+fmtNum(rest)+' '+pr.timeUnit);",
    "    }",
    "    return out;",
    "  };",
    "  PublishMap.prototype.computeMeasurePixels=function(includePreview){",
    "    var pts=this.measurePts.slice();",
    "    if(includePreview && this.measurePreview && pts.length>=1) pts.push(this.measurePreview);",
    "    if(pts.length<2) return null;",
    "    var px=0;",
    "    for(var i=1;i<pts.length;i++){",
    "      var a=pts[i-1], b=pts[i];",
    "      var dx=(b.x-a.x)*this.imgW, dy=(b.y-a.y)*this.imgH;",
    "      px += Math.sqrt(dx*dx+dy*dy);",
    "    }",
    "    return px;",
    "  };",
    "  PublishMap.prototype.updateMeasureHud=function(){",
    "    var ptsCount=this.measurePts.length + ((this.measuring && this.measurePreview)?1:0);",
    "    if(this.measuring || ptsCount>=2){",
    "      var px=this.computeMeasurePixels(true);",
    "      var mpp=this.getMetersPerPixel();",
    "      var meas=this.data && this.data.measurement ? this.data.measurement : null;",
    "      var unit=meas && meas.displayUnit ? String(meas.displayUnit) : 'km';",
    "      var lines=[];",
    "      if(px==null){",
    "        lines.push('Distance: (none)');",
    "      }else if(unit==='custom'){",
    "        lines.push('Distance: '+this.formatCustomDistanceFromPixels(px));",
    "      }else if(!mpp){",
    "        lines.push('Distance: '+Math.round(px)+' px');",
    "      }else{",
    "        lines.push('Distance: '+this.formatDistance(px*mpp));",
    "      }",
    "      // Travel time requires meters",
    "      if(px!=null && mpp){",
    "        var tt=this.computeTravelTimeLines(px*mpp);",
    "        for(var i=0;i<tt.length;i++) lines.push(tt[i]);",
    "      }",
    "      this.measureHud.textContent=lines.join('\\n');",
    "      this.measureHud.classList.add('zm-measure-hud-visible');",
    "    }else{",
    "      this.measureHud.classList.remove('zm-measure-hud-visible');",
    "    }",
    "  };",
    "  PublishMap.prototype.renderMeasure=function(){",
    "    this.measureSvg.setAttribute('width', String(this.imgW));",
    "    this.measureSvg.setAttribute('height', String(this.imgH));",
    "    var pts=this.measurePts.slice();",
    "    if(this.measuring && this.measurePreview) pts.push(this.measurePreview);",
    "    var d='';",
    "    for(var i=0;i<pts.length;i++){",
    "      var p=pts[i];",
    "      var ax=p.x*this.imgW, ay=p.y*this.imgH;",
    "      d += (i===0?'M ':' L ') + ax + ' ' + ay;",
    "    }",
    "    this.measurePath.setAttribute('d', d);",
    "    while(this.measureDots.firstChild) this.measureDots.removeChild(this.measureDots.firstChild);",
    "    for(var j=0;j<this.measurePts.length;j++){",
    "      var q=this.measurePts[j];",
    "      var c=document.createElementNS('http://www.w3.org/2000/svg','circle');",
    "      c.setAttribute('cx', String(q.x*this.imgW));",
    "      c.setAttribute('cy', String(q.y*this.imgH));",
    "      c.setAttribute('r','4');",
    "      c.classList.add('zm-measure__dot');",
    "      this.measureDots.appendChild(c);",
    "    }",
    "    this.updateMeasureHud();",
    "  };",
    "",
    "  // ===== Context menu =====",
    "  PublishMap.prototype.openContextMenu=function(clientX,clientY){",
    "    var self=this;",
    "    self.closeMenu();",
    "    var items=[];",
    "",
    "    // Image layers: bases + overlays",
    "    var bases=self.getBasesNormalized();",
    "    var baseItems=bases.map(function(b){",
    "      var label=(b.name&&String(b.name).trim()) ? b.name : (String(b.path).split('/').pop()||b.path);",
    "      return { label: label, checked: (self.getActiveBasePath()===b.path), action: function(){ self.setActiveBase(b.path); } };",
    "    });",
    "    var overlays=self.getOverlaysNormalized();",
    "    var overlayItems=overlays.map(function(o, idx){",
    "      var label=(o.name&&String(o.name).trim()) ? o.name : (String(o.path).split('/').pop()||o.path);",
    "      return { label: label, checked: (o.visible===true), action: function(){",
    "        // Toggle in-memory only. If overlays came from markers data, update that object too.",
    "        o.visible = !(o.visible===true);",
    "        if(self.data && Array.isArray(self.data.overlays)){",
    "          for(var i=0;i<self.data.overlays.length;i++){",
    "            if(self.data.overlays[i] && self.data.overlays[i].path===o.path){ self.data.overlays[i].visible=o.visible; }",
    "          }",
    "        }",
    "        self.renderOverlays(); self.renderCanvas();",
    "      } };",
    "    });",
    "    items.push({ label: 'Image layers', children: [",
    "      { label: 'Base', children: baseItems },",
    "      { label: 'Overlays', children: overlayItems }",
    "    ]});",
    "",
    "    var layers = (self.data && Array.isArray(self.data.layers)) ? self.data.layers : [];",
    "    var layerItems = layers.filter(function(l){ return !isHiddenLayerName(l && l.name ? l.name : ''); }).map(function(l){",
    "      return { label: (l.name||l.id), checked: (l.visible!==false), action: function(){ l.visible = !(l.visible!==false); self.renderMarkers(); } };",
    "    });",
    "    items.push({ label: 'Marker layers', children: layerItems });",
    "",
    "    var drawLayers = (self.data && Array.isArray(self.data.drawLayers)) ? self.data.drawLayers : [];",
    "    if(drawLayers.length){",
    "      var drawLayerItems = drawLayers.map(function(dl){",
    "        return { label: (dl.name||dl.id), checked: (dl.visible===true), action: function(){ dl.visible = !(dl.visible===true); self.renderDrawings(); } };",
    "      });",
    "      items.push({ label: 'Draw layers', children: drawLayerItems });",
    "    }",
    "",
    "    // Measure menu: unit + travel preset toggles (in-memory only)",
    "    var meas = self.data && self.data.measurement ? self.data.measurement : (self.data.measurement = { displayUnit:'km', scales:{}, travelTimePresetIds:[] });",
    "    if(!Array.isArray(meas.travelTimePresetIds)) meas.travelTimePresetIds=[];",
    "    var unitItems=[",
    "      { label:'m', checked:(meas.displayUnit==='m'), action:function(){ meas.displayUnit='m'; meas.customUnitId=''; self.updateMeasureHud(); } },",
    "      { label:'km', checked:(meas.displayUnit==='km'), action:function(){ meas.displayUnit='km'; meas.customUnitId=''; self.updateMeasureHud(); } },",
    "      { label:'mi', checked:(meas.displayUnit==='mi'), action:function(){ meas.displayUnit='mi'; meas.customUnitId=''; self.updateMeasureHud(); } },",
    "      { label:'ft', checked:(meas.displayUnit==='ft'), action:function(){ meas.displayUnit='ft'; meas.customUnitId=''; self.updateMeasureHud(); } }",
    "    ];",
    "    var cus=self.getActiveCustomUnits();",
    "    if(cus && cus.length){",
    "      unitItems.push({ type:'separator' });",
    "      for(var cu=0;cu<cus.length;cu++){",
    "        (function(def){",
    "          var label=(def.abbreviation? (def.name+' ('+def.abbreviation+')') : def.name) || def.id;",
    "          unitItems.push({ label: label, checked:(meas.displayUnit==='custom' && meas.customUnitId===def.id), action:function(){ meas.displayUnit='custom'; meas.customUnitId=def.id; self.updateMeasureHud(); } });",
    "        })(cus[cu]);",
    "      }",
    "    }",
    "",
    "    var travelPresets=self.getActiveTravelTimePresets();",
    "    var travelItems=[];",
    "    for(var tp=0;tp<travelPresets.length;tp++){",
    "      (function(p){",
    "        var checked=(meas.travelTimePresetIds.indexOf(p.id)>=0);",
    "        travelItems.push({ label:(p.name||p.id), checked:checked, action:function(){",
    "          var i=meas.travelTimePresetIds.indexOf(p.id);",
    "          if(i>=0) meas.travelTimePresetIds.splice(i,1); else meas.travelTimePresetIds.push(p.id);",
    "          self.updateMeasureHud();",
    "        }});",
    "      })(travelPresets[tp]);",
    "    }",
    "    if(travelItems.length){",
    "      travelItems.push({ type:'separator' });",
    "      travelItems.push({ label:'Show travel days', checked:(meas.travelDaysEnabled===true), action:function(){ meas.travelDaysEnabled = !(meas.travelDaysEnabled===true); self.updateMeasureHud(); } });",
    "    }",
    "",
    "    items.push({ label: 'Measure', children: [",
    "      { label: (self.measuring?'Stop measuring':'Start measuring'), action: function(){ self.toggleMeasure(); } },",
    "      { label: 'Clear measurement', action: function(){ self.clearMeasure(); } },",
    "      { label: 'Remove last point', action: function(){ self.removeLastMeasurePoint(); } },",
    "      { type:'separator' },",
    "      { label: 'Unit', children: unitItems },",
    "      (travelItems.length ? { label:'Travel time', children: travelItems } : null)",
    "    ].filter(Boolean)});",
    "    items.push({ type:'separator' });",
    "    items.push({ label:'Fit to window', action:function(){ self.fitToView(); self.renderMarkers(); self.renderCanvas(); } });",
    "    items.push({ label:'Zoom +', action:function(){ self.zoomAt(clientX,clientY,1.2); } });",
    "    items.push({ label:'Zoom -', action:function(){ self.zoomAt(clientX,clientY,1/1.2); } });",
    "    self.menu = new Menu(document);",
    "    self.menu.open(clientX,clientY,items);",
    "  };",
    "  PublishMap.prototype.closeMenu=function(){ if(this.menu){ this.menu.destroy(); this.menu=null; } };",
    "",
    "  function Menu(doc){ this.doc=doc; this.root=doc.body.appendChild(doc.createElement('div')); this.root.className='zm-menu'; this.submenus=[]; }",
    "  Menu.prototype.open=function(x,y,items){ this.buildList(this.root,items); this.position(this.root,x,y,'right'); };",
    "  Menu.prototype.destroy=function(){ for(var i=0;i<this.submenus.length;i++) this.submenus[i].remove(); this.submenus=[]; this.root.remove(); };",
    "  Menu.prototype.contains=function(node){ if(this.root.contains(node)) return true; for(var i=0;i<this.submenus.length;i++) if(this.submenus[i].contains(node)) return true; return false; };",
    "  Menu.prototype.buildList=function(container,items){",
    "    container.innerHTML='';",
    "    var self=this;",
    "    items.forEach(function(it){",
    "      if(it && it.type==='separator'){ var sep=container.appendChild(self.doc.createElement('div')); sep.className='zm-menu__sep'; return; }",
    "      if(!it || !it.label) return;",
    "      var row=container.appendChild(self.doc.createElement('div')); row.className='zm-menu__item';",
    "      var label=row.appendChild(self.doc.createElement('div')); label.className='zm-menu__label'; label.textContent=it.label;",
    "      var right=row.appendChild(self.doc.createElement('div')); right.className='zm-menu__right';",
    "      if(it.children && it.children.length){",
    "        var arrow=right.appendChild(self.doc.createElement('div')); arrow.className='zm-menu__arrow'; arrow.textContent='';",
    "        var submenu=null;",
    "        var openSub=function(){",
    "          if(submenu) return;",
    "          submenu=self.doc.body.appendChild(self.doc.createElement('div')); submenu.className='zm-submenu'; self.submenus.push(submenu);",
    "          self.buildList(submenu,it.children);",
    "          var r=row.getBoundingClientRect();",
    "          var pref=(r.right+280<window.innerWidth)?'right':'left';",
    "          var sx=(pref==='right')?r.right:r.left;",
    "          self.position(submenu,sx,r.top,pref);",
    "        };",
    "        var closeSub=function(ev){ if(!submenu) return; var to=ev && ev.relatedTarget; if(to && submenu.contains(to)) return; submenu.remove(); self.submenus=self.submenus.filter(function(s){return s!==submenu;}); submenu=null; };",
    "        row.addEventListener('mouseenter', openSub);",
    "        row.addEventListener('mouseleave', closeSub);",
    "      }else{",
    "        var chk=right.appendChild(self.doc.createElement('div')); chk.className='zm-menu__check'; chk.textContent = it.checked ? '' : '';",
    "        row.addEventListener('click', function(){ if(typeof it.action==='function') it.action(row,self); });",
    "      }",
    "    });",
    "  };",
    "  Menu.prototype.position=function(el,x,y,prefer){",
    "    var pad=6; var rect=el.getBoundingClientRect(); var vw=window.innerWidth, vh=window.innerHeight;",
    "    var px=x, py=y;",
    "    if(prefer==='right'){ if(px+rect.width+pad>vw) px=Math.max(pad, vw-rect.width-pad); }",
    "    else { px=x-rect.width; if(px<pad) px=pad; }",
    "    if(py+rect.height+pad>vh) py=Math.max(pad, vh-rect.height-pad);",
    "    el.style.left=Math.round(px)+'px'; el.style.top=Math.round(py)+'px';",
    "  };",
    "",
    "  function initOne(codeEl){",
    "    var pre = codeEl && codeEl.closest ? codeEl.closest('pre') : null;",
    "    if(!pre || STATE.inited.has(pre)) return;",
    "    STATE.inited.add(pre);",
    "    var cfg=parseZoommapYaml(codeEl.textContent||'');",
    "    if(!cfg || !cfg.imagePath) return;",
    "    var host=document.createElement('div'); host.className='zm-root';",
    "    pre.replaceWith(host);",
    "    ensureLibrary().then(function(lib){",
    "      return fetchNoteJson(cfg.markersNote).then(function(data){",
    "        var map=new PublishMap(host,cfg,data,lib);",
    "        return map.init();",
    "      });",
    "    }).catch(function(err){",
    "      console.warn('ZoomMap Publish: init failed', err);",
    "      host.textContent='ZoomMap Publish: failed to load map data.';",
    "    });",
    "  }",
    "",
    "  function findZoommapBlocks(){",
    "    var nodes=document.querySelectorAll('pre > code');",
    "    var out=[];",
    "    for(var i=0;i<nodes.length;i++){",
    "      var c=nodes[i];",
    "      var cls=(c.className||'');",
    "      if(cls.indexOf('language-zoommap')>=0 || cls.indexOf('lang-zoommap')>=0) out.push(c);",
    "    }",
    "    return out;",
    "  }",
    "",
    "  function findTimelineBlocks(){",
    "    var nodes=document.querySelectorAll('pre > code');",
    "    var out=[];",
    "    for(var i=0;i<nodes.length;i++){",
    "      var c=nodes[i];",
    "      var cls=(c.className||'');",
    "      var isCal = (cls.indexOf('language-timeline-cal')>=0 || cls.indexOf('lang-timeline-cal')>=0);",
    "      var isH = (cls.indexOf('language-timeline-h')>=0 || cls.indexOf('lang-timeline-h')>=0);",
    "      if(isCal || isH) out.push({ code: c, kind: (isH ? 'h' : 'cal') });",
    "    }",
    "    return out;",
    "  }",
    "",
    "  function parseTimelineYaml(raw){",
    "    var lines = String(raw||'').split('\\n').map(function(ln){ return stripQuotePrefix(ln); });",
    "    // very small YAML subset: scalars + list blocks",
    "    var scalars = {};",
    "    var blocks = {};",
    "    var i=0;",
    "    function isTopKey(ln){",
    "      if(!ln) return false;",
    "      if(/^\\s+#/.test(ln)) return false;",
    "      return /^([A-Za-z0-9_-]+)\\s*:\\s*(.*)$/.test(ln) && (/^\\S/.test(ln));",
    "    }",
    "    while(i<lines.length){",
    "      var ln=lines[i];",
    "      if(!ln.trim() || ln.trim().startsWith('#')){ i++; continue; }",
    "      var m=/^([A-Za-z0-9_-]+)\\s*:\\s*(.*)$/.exec(ln);",
    "      if(!m){ i++; continue; }",
    "      var key=m[1];",
    "      var rest=(m[2]||'').trim();",
    "      i++;",
    "      if(rest){ scalars[key]=rest; continue; }",
    "      var block=[];",
    "      while(i<lines.length){",
    "        var nx=lines[i];",
    "        if(isTopKey(nx)) break;",
    "        block.push(nx);",
    "        i++;",
    "      }",
    "      blocks[key]=block;",
    "    }",
    "",
    "    function parseListBlock(block){",
    "      var out=[];",
    "      if(!block) return out;",
    "      for(var j=0;j<block.length;j++){",
    "        var ln=block[j];",
    "        if(!ln || !ln.trim() || ln.trim().startsWith('#')) continue;",
    "        var t=ln.trim();",
    "        if(t.startsWith('-')){",
    "          var v=t.slice(1).trim();",
    "          if(v) out.push(stripQuotes(v));",
    "        }",
    "      }",
    "      return out;",
    "    }",
    "",
    "    function splitNames(s){",
    "      var cleaned = String(s||'').replace(/[\\[\\]\"]/g,'');",
    "      return cleaned.split(/[,;\\n]+/g).map(function(x){return x.trim();}).filter(Boolean);",
    "    }",
    "",
    "    var names=[];",
    "    if(scalars.names) names = splitNames(scalars.names);",
    "    else if(scalars.name) names = splitNames(scalars.name);",
    "    else if(blocks.names) names = parseListBlock(blocks.names);",
    "",
    "    var mode = String(scalars.mode||'mixed').trim().toLowerCase();",
    "    if(mode!=='stacked' && mode!=='mixed') mode='mixed';",
    "",
    "    var align = String(scalars.align||'left').trim().toLowerCase();",
    "    if(align!=='right' && align!=='left') align='left';",
    "",
    "    var maxSummaryLines = parseInt(String(scalars.maxSummaryLines||scalars.summaryLines||'6'), 10);",
    "    if(!isFinite(maxSummaryLines) || maxSummaryLines<1) maxSummaryLines=6;",
    "",
    "    var dedupeRaw = String(scalars.dedupe||'false').trim().toLowerCase();",
    "    var dedupe = (dedupeRaw==='true');",
    "",
    "    var cardWidth = parseInt(String(scalars.cardWidth||'200'), 10);",
    "    if(!isFinite(cardWidth) || cardWidth<80) cardWidth=200;",
    "",
    "    var cardHeight = parseInt(String(scalars.cardHeight||'315'), 10);",
    "    if(!isFinite(cardHeight) || cardHeight<80) cardHeight=315;",
    "",
    "    var boxHeight = parseInt(String(scalars.boxHeight||'289'), 10);",
    "    if(!isFinite(boxHeight) || boxHeight<60) boxHeight=289;",
    "",
    "    return { names:names, mode:mode, align:align, maxSummaryLines:maxSummaryLines, cardWidth:cardWidth, cardHeight:cardHeight, boxHeight:boxHeight, dedupe: dedupe };",
    "  }",
    "",
    "  function ymdSortKey(ymd){ return (ymd.y*10000 + ymd.m*100 + ymd.d); }",
    "  function formatRange(start, end){",
    "    function pad(n){return String(n);}",
    "    function fmt(x){ return pad(x.d)+'-'+pad(x.m)+'-'+pad(x.y); }",
    "    if(!end) return fmt(start);",
    "    if(start.y===end.y && start.m===end.m && start.d===end.d) return fmt(start);",
    "    if(start.y===end.y && start.m===end.m) return String(start.d)+''+String(end.d)+'-'+pad(start.m)+'-'+pad(start.y);",
    "    return fmt(start) + '  ' + fmt(end);",
    "  }",
    "",
    "  function normalizeInternalLinkTarget(path){",
    "    var p=String(path||'').trim();",
    "    if(!p) return '';",
    "    p=stripWikiBrackets(p);",
    "    p=p.split('#')[0].split('?')[0];",
    "    p=p.replace(/\\\\/g,'/');",
    "    p=p.replace(/^\\/+/, '');",
    "    p=p.replace(/\\/{2,}/g,'/');",
    "    p=stripMdExt(p);",
    "    return p;",
    "  }",
    "",
    "  function resolveMaybeAssetUrl(img){",
    "    var s=String(img||'').trim();",
    "    if(!s) return '';",
    "    if(/^data:/.test(s) || /^https?:\\/\\//i.test(s)) return s;",
    "    return resolveAssetUrl(s, false);",
    "  }",
    "",
    "  function buildTimelineRow(entry, opts){",
    "    var row=document.createElement('div');",
    "    row.className='tl-row' + (opts.align==='right'?' tl-align-right':'');",
    "",
    "    var grid=document.createElement('div');",
    "    grid.className='tl-grid ' + (entry.img ? 'has-media' : 'no-media');",
    "    grid.style.setProperty('--tl-media-w', String(opts.cardWidth)+'px');",
    "    row.appendChild(grid);",
    "",
    "    if(entry.img){",
    "      var media=document.createElement('div');",
    "      media.className='tl-media';",
    "      media.style.width=String(opts.cardWidth)+'px';",
    "      media.style.height=String(opts.cardHeight)+'px';",
    "      var img=document.createElement('img');",
    "      img.loading='lazy';",
    "      img.alt=entry.title || '';",
    "      img.src=resolveMaybeAssetUrl(entry.img);",
    "      img.style.width='100%';",
    "      img.style.height='100%';",
    "      img.style.objectFit='cover';",
    "      media.appendChild(img);",
    "      grid.appendChild(media);",
    "",
    "      // hover anchor (image)",
    "      var aImg=document.createElement('a');",
    "      aImg.className='internal-link tl-hover-anchor';",
    "      aImg.setAttribute('data-href', normalizeInternalLinkTarget(entry.notePath));",
    "      aImg.href=resolveNoteHref(entry.notePath);",
    "      media.appendChild(aImg);",
    "    }",
    "",
    "    var box=document.createElement('div');",
    "    box.className='tl-box' + (entry.img?' has-media':'');",
    "    box.style.height=String(opts.boxHeight)+'px';",
    "    grid.appendChild(box);",
    "",
    "    var h1=document.createElement('h1');",
    "    h1.className='tl-title';",
    "    h1.textContent=entry.title || '';",
    "    box.appendChild(h1);",
    "",
    "    var h4=document.createElement('h4');",
    "    h4.className='tl-date';",
    "    // Prefer baked dateText (includes custom months from desktop settings)",
    "    // Fallback to numeric formatting if missing.",
    "    h4.textContent=(entry.dateText ? String(entry.dateText) : formatRange(entry.start, entry.end));",
    "    box.appendChild(h4);",
    "",
    "    var sum=document.createElement('div');",
    "    sum.className='tl-summary tl-clamp';",
    "    sum.style.setProperty('--tl-summary-lines', String(opts.maxSummaryLines));",
    "    sum.textContent=entry.summary || '';",
    "    box.appendChild(sum);",
    "",
    "    var aBox=document.createElement('a');",
    "    aBox.className='internal-link tl-hover-anchor';",
    "    aBox.setAttribute('data-href', normalizeInternalLinkTarget(entry.notePath));",
    "    aBox.href=resolveNoteHref(entry.notePath);",
    "    box.appendChild(aBox);",
    "",
    "    return row;",
    "  }",
    "",
    "  function renderTimelineCal(host, entries, opts){",
    "    host.innerHTML='';",
    "    var controls=document.createElement('div');",
    "    controls.className='tl-controls';",
    "    host.appendChild(controls);",
    "",
    "    var wrap=document.createElement('div');",
    "    wrap.className='tl-wrapper tl-cross-mode';",
    "    host.appendChild(wrap);",
    "",
    "    for(var i=0;i<entries.length;i++){",
    "      wrap.appendChild(buildTimelineRow(entries[i], opts));",
    "    }",
    "  }",
    "",
    "  function renderTimelineH(host, groupedByName, allEntriesSorted, opts){",
    "    host.innerHTML='';",
    "    var controls=document.createElement('div');",
    "    controls.className='tl-controls';",
    "    host.appendChild(controls);",
    "",
    "    var scroller=document.createElement('div');",
    "    scroller.className='tl-h-scroller';",
    "    host.appendChild(scroller);",
    "",
    "    var wrapper=document.createElement('div');",
    "    wrapper.className='tl-h-content ' + (opts.mode==='stacked' ? 'tl-h-stacked' : 'tl-h-mixed');",
    "    scroller.appendChild(wrapper);",
    "",
    "    if(opts.mode!=='stacked'){",
    "      for(var i=0;i<allEntriesSorted.length;i++){",
    "        var row=buildTimelineRow(allEntriesSorted[i], opts);",
    "        row.classList.add('tl-h-item');",
    "        wrapper.appendChild(row);",
    "      }",
    "      return;",
    "    }",
    "",
    "    // stacked: union axis of start dates",
    "    var axisKeys=[]; var seen={};",
    "    for(var a=0;a<allEntriesSorted.length;a++){",
    "      var k=ymdSortKey(allEntriesSorted[a].start);",
    "      if(!seen[k]){ seen[k]=true; axisKeys.push(k); }",
    "    }",
    "    axisKeys.sort(function(x,y){return x-y;});",
    "    var colByKey={};",
    "    for(var c=0;c<axisKeys.length;c++) colByKey[axisKeys[c]] = (c+1);",
    "",
    "    wrapper.style.setProperty('--tl-h-cols', String(axisKeys.length));",
    "",
    "    var names=Object.keys(groupedByName);",
    "    for(var n=0;n<names.length;n++){",
    "      var name=names[n];",
    "      var list=groupedByName[name] || [];",
    "",
    "      var tlRowWrap=document.createElement('div');",
    "      tlRowWrap.className='tl-h-timeline';",
    "      wrapper.appendChild(tlRowWrap);",
    "",
    "      var rowGrid=document.createElement('div');",
    "      rowGrid.className='tl-h-row';",
    "      rowGrid.style.setProperty('--tl-h-cols', String(axisKeys.length));",
    "      tlRowWrap.appendChild(rowGrid);",
    "",
    "      // group by date key",
    "      var byDate={};",
    "      for(var i2=0;i2<list.length;i2++){",
    "        var kk=ymdSortKey(list[i2].start);",
    "        (byDate[kk]||(byDate[kk]=[])).push(list[i2]);",
    "      }",
    "",
    "      var dateKeys=Object.keys(byDate).map(function(x){return parseInt(x,10);}).filter(isFinite);",
    "      dateKeys.sort(function(x,y){return (colByKey[x]||0)-(colByKey[y]||0);});",
    "",
    "      for(var d=0;d<dateKeys.length;d++){",
    "        var dk=dateKeys[d];",
    "        var col=colByKey[dk];",
    "        if(!col) continue;",
    "        var slot=document.createElement('div');",
    "        slot.className='tl-h-slot';",
    "        slot.style.setProperty('--tl-h-col', String(col));",
    "        rowGrid.appendChild(slot);",
    "        var items=byDate[dk] || [];",
    "        for(var z=0;z<items.length;z++){",
    "          var row2=buildTimelineRow(items[z], opts);",
    "          row2.classList.add('tl-h-item');",
    "          slot.appendChild(row2);",
    "        }",
    "      }",
    "    }",
    "  }",
    "",
    "  function dedupeEntries(list){",
    "    var out=[];",
    "    var seen={};",
    "    for(var i=0;i<list.length;i++){",
    "      var e=list[i];",
    "      var k=String(e.notePath||'') + '|' + String(ymdSortKey(e.start));",
    "      if(seen[k]) continue;",
    "      seen[k]=true;",
    "      out.push(e);",
    "    }",
    "    return out;",
    "  }",
    "",
    "  function loadTimelineEntriesForName(name){",
    "    var note = TL_PREFIX + hashKeyToId(name);",
    "    return fetchNoteJson(note).then(function(obj){",
    "      // expected: { timelineName, entries: [...] }",
    "      if(!obj || !obj.entries || !Array.isArray(obj.entries)) return { name:name, entries:[] };",
    "      return { name:(obj.timelineName||name), entries:obj.entries };",
    "    }).catch(function(_e){",
    "      return { name:name, entries:[] };",
    "    });",
    "  }",
    "",
    "  function initTimelineOne(item){",
    "    var codeEl=item.code;",
    "    var pre = codeEl && codeEl.closest ? codeEl.closest('pre') : null;",
    "    if(!pre || STATE.inited.has(pre)) return;",
    "    STATE.inited.add(pre);",
    "",
    "    var opts=parseTimelineYaml(codeEl.textContent||'');",
    "    if(!opts.names || !opts.names.length){",
    "      var err=document.createElement('div');",
    "      err.textContent='Timeline: missing \"names:\" in code block.';",
    "      pre.replaceWith(err);",
    "      return;",
    "    }",
    "",
    "    var host=document.createElement('div');",
    "    host.className='tl-publish-root';",
    "    host.textContent='Loading timeline';",
    "    pre.replaceWith(host);",
    "",
    "    Promise.all(opts.names.map(function(n){ return loadTimelineEntriesForName(n); }))",
    "      .then(function(groups){",
    "        var grouped={};",
    "        var all=[];",
    "        for(var i=0;i<groups.length;i++){",
    "          var g=groups[i];",
    "          var list = Array.isArray(g.entries) ? g.entries : [];",
    "          for(var j=0;j<list.length;j++){",
    "            var e=list[j];",
    "            if(!e || !e.start) continue;",
    "            // normalize minimal shape",
    "            if(!e.title) e.title='';",
    "            if(!e.summary) e.summary='';",
    "            all.push(e);",
    "          }",
    "          grouped[g.name]=list;",
    "        }",
    "        // IMPORTANT: default is NO dedupe, because users may want entries to appear multiple times",
    "        // when the same note is part of multiple timelines.",
    "        if(opts.dedupe===true){",
    "          all = dedupeEntries(all);",
    "        }",
    "        all.sort(function(a,b){ return ymdSortKey(a.start)-ymdSortKey(b.start); });",
    "",
    "        if(item.kind==='h'){",
    "          renderTimelineH(host, grouped, all, opts);",
    "        }else{",
    "          renderTimelineCal(host, all, opts);",
    "        }",
    "      })",
    "      .catch(function(err){",
    "        console.warn('Timeline Publish: init failed', err);",
    "        host.textContent='Timeline Publish: failed to load timeline data.';",
    "      });",
    "  }",
    "",
    "  function scan(){",
    "    findZoommapBlocks().forEach(function(c){ initOne(c); });",
    "    findTimelineBlocks().forEach(function(it){ initTimelineOne(it); });",
    "  }",
    "",
    "  function applyHoverPopoverSizing(){",
    "    // CSS should normally handle this, but Publish styles can be stubborn depending on theme/version.",
    "    // So we also enforce sizing inline.",
    "    var w = 'min(' + HOVER_POPOVER_MAX_WIDTH + ', 92vw)';",
    "    var h = '92vh';",
    "    function isHoverPopover(el){",
    "      if(!el || !el.classList) return false;",
    "      if(el.classList.contains('hover-popover')) return true;",
    "      if(el.classList.contains('popover') && el.classList.contains('hover-popover')) return true;",
    "      if(el.classList.contains('popover') && (el.querySelector('.hover-popover-content') || el.querySelector('.popover-content'))) return true;",
    "      return false;",
    "    }",
    "    function applyOne(el, reschedule){",
    "      if(!el || !el.style) return;",
    "      try{",
    "        el.style.setProperty('--popover-width', w, 'important');",
    "        el.style.setProperty('width', w, 'important');",
    "        el.style.setProperty('max-width', w, 'important');",
    "        el.style.setProperty('max-height', h, 'important');",
    "        el.style.setProperty('height', 'auto', 'important');",
    "        el.style.setProperty('overflow', 'hidden', 'important');",
    "        el.style.setProperty('display', 'flex', 'important');",
    "        el.style.setProperty('flex-direction', 'column', 'important');",
    "      }catch(_e){}",
    "",
    "      var sels = [",
    "        '.hover-popover-content',",
    "        '.popover-content'",
    "      ];",
    "      for(var s=0;s<sels.length;s++){",
    "        var node = el.querySelector(sels[s]);",
    "        if(!node || !node.style) continue;",
    "        try{",
    "          node.style.setProperty('width', '100%', 'important');",
    "          node.style.setProperty('max-width', '100%', 'important');",
    "          node.style.setProperty('height', 'auto', 'important');",
    "          node.style.setProperty('max-height', '100%', 'important');",
    "          node.style.setProperty('min-height', '0', 'important');",
    "          node.style.setProperty('overflow', 'auto', 'important');",
    "          node.style.setProperty('flex', '1 1 auto', 'important');",
    "        }catch(_e2){}",
    "      }",
    "",
    "      var inner = el.querySelector('.markdown-preview-view') || el.querySelector('.markdown-preview-section');",
    "      if(inner && inner.style){",
    "        try{",
    "          inner.style.setProperty('width', '100%', 'important');",
    "          inner.style.setProperty('max-width', '100%', 'important');",
    "          inner.style.setProperty('height', 'auto', 'important');",
    "          inner.style.setProperty('max-height', '100%', 'important');",
    "          inner.style.setProperty('min-height', '0', 'important');",
    "          inner.style.setProperty('overflow', 'auto', 'important');",
    "        }catch(_e3){}",
    "      }",
    "",
    "      if(reschedule) return;",
    "      if(el.__ttrpgtoolsHoverPopSized) return;",
    "      el.__ttrpgtoolsHoverPopSized = 1;",
    "      var rerun = function(){ applyOne(el, true); };",
    "      try{ requestAnimationFrame(rerun); }catch(_e4){}",
    "      try{ setTimeout(rerun, 60); }catch(_e5){}",
    "      try{ setTimeout(rerun, 250); }catch(_e6){}",
    "    }",
    "",
    "    var nodes = document.querySelectorAll('.hover-popover, .popover');",
    "    for(var i=0;i<nodes.length;i++){",
    "      var el = nodes[i];",
    "      if(!isHoverPopover(el)) continue;",
    "      applyOne(el, false);",
    "    }",
    "  }",
    "  function scanAll(){",
    "    applyNavHiding();",
	"    applyHoverPopoverSizing();",
    "    scan();",
    "  }",
    "  function schedule(){ if(STATE.raf) return; STATE.raf=requestAnimationFrame(function(){ STATE.raf=0; scanAll(); }); }",
    "",
    "  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', schedule); else schedule();",
    "  var mo=new MutationObserver(function(){ schedule(); });",
    "  mo.observe(document.body,{childList:true,subtree:true});",
    "",
    "})();",
    "",
    ZM_END_JS,
    "",
  ].join("\n");

  return js;
}